{% extends 'base/layout.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-[92%] mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">{{ title }}</h1>

    <div class="bg-white rounded-lg shadow-md p-6 max-w-xl" x-data="restructurePreview({{ remaining_amount }})">
        <p class="text-gray-700 mb-4">Elige c√≥mo quieres reestructurar. El total pendiente se mantiene. Ver√°s en tiempo real c√≥mo quedar√°n los pagos antes de guardar.</p>

        <div class="mb-6 p-4 bg-amber-50 rounded-lg border border-amber-200">
            <p class="text-sm text-amber-800 font-medium">Plan: {{ plan.name }}</p>
            <p class="text-sm text-amber-800 mt-1">Pendiente de pagar: {{ remaining_amount|decimal_eu(2) }} ‚Ç¨ en {{ remaining_months }} cuotas actuales ({{ plan.monthly_payment|decimal_eu(2) }} ‚Ç¨/mes)</p>
        </div>

        <form method="POST" action="" id="restructure-form" novalidate>
            {{ form.hidden_tag() }}

            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Reestructurar por</label>
                <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="restructure_mode" value="by_amount"
                               x-model="mode" @change="updatePreview()"
                               class="mr-2">
                        <span>Nueva cuota mensual (‚Ç¨)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="restructure_mode" value="by_months"
                               x-model="mode" @change="updatePreview()"
                               class="mr-2">
                        <span>N√∫mero de meses</span>
                    </label>
                </div>
            </div>

            <div class="mb-4" x-show="mode === 'by_amount'">
                <label class="block text-gray-700 font-semibold mb-2">Nueva cuota mensual (‚Ç¨)</label>
                <input type="number" name="new_monthly_payment" step="0.01" min="0.01"
                       x-model="inputAmount"
                       @input="updatePreview()"
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Ej: 150.00">
                <div class="text-red-600 text-sm mt-1" x-show="errors.amount" x-text="errors.amount"></div>
            </div>

            <div class="mb-4" x-show="mode === 'by_months'" x-cloak style="display: none;">
                <label class="block text-gray-700 font-semibold mb-2">Meses restantes</label>
                <input type="number" name="new_months" min="1"
                       x-model="inputMonths"
                       @input="updatePreview()"
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Ej: 12">
                <div class="text-red-600 text-sm mt-1" x-show="errors.months" x-text="errors.months"></div>
            </div>

            <!-- Vista previa en tiempo real -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200" x-show="previewValid">
                <p class="text-sm font-semibold text-blue-900 mb-2">üìã Vista previa</p>
                <p class="text-blue-800">Cuota mensual: <strong x-text="previewPayment + ' ‚Ç¨'"></strong></p>
                <p class="text-blue-800">Meses a pagar: <strong x-text="previewMonths"></strong></p>
            </div>

            <div class="flex space-x-3">
                <button type="button" onclick="var f=document.getElementById('restructure-form');f.requestSubmit?f.requestSubmit():f.submit()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition font-semibold">
                    Reestructurar plan
                </button>
                <a href="{{ url_for('debts.dashboard') }}" class="flex-1 text-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg transition font-semibold">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('alpine:init', function() {
    Alpine.data('restructurePreview', function(remainingAmount) {
        return {
            remainingAmount: parseFloat(remainingAmount) || 0,
            mode: 'by_amount',
            inputAmount: {{ plan.monthly_payment }},
            inputMonths: {{ remaining_months }},
            previewPayment: 0,
            previewMonths: 0,
            previewValid: false,
            errors: { amount: '', months: '' },
            updatePreview() {
                this.errors = { amount: '', months: '' };
                if (this.mode === 'by_amount') {
                    var amt = parseFloat(this.inputAmount);
                    if (!amt || amt <= 0) {
                        this.previewValid = false;
                        return;
                    }
                    this.previewMonths = Math.max(1, Math.ceil(this.remainingAmount / amt));
                    this.previewPayment = (this.remainingAmount / this.previewMonths).toFixed(2);
                    this.previewValid = true;
                } else {
                    var m = parseInt(this.inputMonths);
                    if (!m || m < 1) {
                        this.previewValid = false;
                        return;
                    }
                    this.previewMonths = m;
                    this.previewPayment = (this.remainingAmount / m).toFixed(2);
                    this.previewValid = true;
                }
            }
        };
    });
});
</script>
{% endblock %}
