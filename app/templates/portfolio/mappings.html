{% extends "base/layout.html" %}

{% block title %}Gesti√≥n de Mapeos - FollowUp{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                üó∫Ô∏è Gesti√≥n de Mapeos
            </h1>
            <p class="text-gray-600 mt-1">Configuraci√≥n de conversiones MIC, Exchange y m√°s</p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('portfolio.asset_registry') }}" 
               class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                ‚Üê Volver a AssetRegistry
            </a>
            <button onclick="openNewModal()" 
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                ‚ûï Nuevo Mapeo
            </button>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="text-blue-600 text-sm font-medium">Total Mapeos</div>
            <div class="text-3xl font-bold text-blue-900">{{ stats.total }}</div>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <div class="text-purple-600 text-sm font-medium">MIC ‚Üí Yahoo</div>
            <div class="text-3xl font-bold text-purple-900">{{ stats.mic_to_yahoo }}</div>
        </div>
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
            <div class="text-indigo-600 text-sm font-medium">Exchange ‚Üí Yahoo</div>
            <div class="text-3xl font-bold text-indigo-900">{{ stats.exchange_to_yahoo }}</div>
        </div>
        <div class="bg-teal-50 border border-teal-200 rounded-lg p-4">
            <div class="text-teal-600 text-sm font-medium">DeGiro ‚Üí IBKR</div>
            <div class="text-3xl font-bold text-teal-900">{{ stats.degiro_to_ibkr }}</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="text-green-600 text-sm font-medium">Activos</div>
            <div class="text-3xl font-bold text-green-900">{{ stats.active }}</div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- B√∫squeda -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">üîç Buscar</label>
                <input type="text" name="search" value="{{ request.args.get('search', '') }}"
                       placeholder="Clave, valor o descripci√≥n..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Tipo de Mapeo -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‚öôÔ∏è Tipo de Mapeo</label>
                <select name="mapping_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Todos</option>
                    <option value="MIC_TO_YAHOO" {% if request.args.get('mapping_type') == 'MIC_TO_YAHOO' %}selected{% endif %}>MIC ‚Üí Yahoo Suffix</option>
                    <option value="EXCHANGE_TO_YAHOO" {% if request.args.get('mapping_type') == 'EXCHANGE_TO_YAHOO' %}selected{% endif %}>Exchange ‚Üí Yahoo Suffix</option>
                    <option value="DEGIRO_TO_IBKR" {% if request.args.get('mapping_type') == 'DEGIRO_TO_IBKR' %}selected{% endif %}>DeGiro ‚Üí IBKR</option>
                </select>
            </div>

            <!-- Pa√≠s -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">üåç Pa√≠s</label>
                <select name="country" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Todos</option>
                    {% for country in countries %}
                    <option value="{{ country }}" {% if request.args.get('country') == country %}selected{% endif %}>{{ country }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Bot√≥n Buscar -->
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Buscar
                </button>
            </div>
        </form>
    </div>

    <!-- Tabla de Mapeos -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clave Origen</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor Destino</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pa√≠s</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if mappings %}
                        {% for mapping in mappings %}
                        <tr class="hover:bg-gray-50" id="row-{{ mapping.id }}">
                            <!-- Tipo -->
                            <td class="px-4 py-3">
                                {% if mapping.mapping_type == 'MIC_TO_YAHOO' %}
                                <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">MIC‚ÜíYahoo</span>
                                {% elif mapping.mapping_type == 'EXCHANGE_TO_YAHOO' %}
                                <span class="px-2 py-1 text-xs font-medium bg-indigo-100 text-indigo-800 rounded">Exch‚ÜíYahoo</span>
                                {% elif mapping.mapping_type == 'DEGIRO_TO_IBKR' %}
                                <span class="px-2 py-1 text-xs font-medium bg-teal-100 text-teal-800 rounded">DeGiro‚ÜíIBKR</span>
                                {% endif %}
                            </td>

                            <!-- Clave -->
                            <td class="px-4 py-3">
                                <span class="font-mono font-semibold text-gray-900">{{ mapping.source_key }}</span>
                            </td>

                            <!-- Valor -->
                            <td class="px-4 py-3">
                                <span class="font-mono text-blue-600">{{ mapping.target_value if mapping.target_value else '(vac√≠o)' }}</span>
                            </td>

                            <!-- Descripci√≥n -->
                            <td class="px-4 py-3 text-sm text-gray-600">
                                {{ mapping.description or '-' }}
                            </td>

                            <!-- Pa√≠s -->
                            <td class="px-4 py-3 text-center">
                                {% if mapping.country %}
                                <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded">{{ mapping.country }}</span>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>

                            <!-- Estado -->
                            <td class="px-4 py-3">
                                {% if mapping.is_active %}
                                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">‚úì Activo</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded">‚óã Inactivo</span>
                                {% endif %}
                            </td>

                            <!-- Acciones -->
                            <td class="px-4 py-3">
                                <div class="flex gap-2">
                                    <button onclick="editMapping({{ mapping.id }}, '{{ mapping.source_key }}', '{{ mapping.target_value }}', '{{ mapping.description or '' }}', '{{ mapping.country or '' }}')"
                                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button onclick="toggleMapping({{ mapping.id }}, '{{ mapping.source_key }}', {{ 'true' if mapping.is_active else 'false' }})"
                                            class="text-orange-600 hover:text-orange-800 text-sm font-medium">
                                        {% if mapping.is_active %}‚è∏Ô∏è{% else %}‚ñ∂Ô∏è{% endif %}
                                    </button>
                                    <button onclick="deleteMapping({{ mapping.id }}, '{{ mapping.source_key }}')"
                                            class="text-red-600 hover:text-red-800 text-sm font-medium">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                No se encontraron mapeos con los filtros aplicados
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 text-sm text-gray-600">
            Mostrando {{ mappings|length }} mapeo(s)
        </div>
    </div>
</div>

<!-- Modal: Nuevo Mapeo -->
<div id="newModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">‚ûï Nuevo Mapeo</h3>
            <button onclick="closeNewModal()" class="text-gray-600 hover:text-gray-900">‚úï</button>
        </div>
        
        <form method="POST" action="{{ url_for('portfolio.mappings_new') }}" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Mapeo *</label>
                    <select name="mapping_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">Seleccionar...</option>
                        <option value="MIC_TO_YAHOO">MIC ‚Üí Yahoo Suffix</option>
                        <option value="EXCHANGE_TO_YAHOO">Exchange ‚Üí Yahoo Suffix</option>
                        <option value="DEGIRO_TO_IBKR">DeGiro ‚Üí IBKR Exchange</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Clave Origen *</label>
                    <input type="text" name="source_key" required placeholder="ej: XMAD, BM, MAD..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Destino *</label>
                    <input type="text" name="target_value" required placeholder="ej: .MC, BM, ''..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s (ISO 2)</label>
                    <input type="text" name="country" maxlength="2" placeholder="ej: ES, US, GB..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                <input type="text" name="description" placeholder="ej: Bolsa de Madrid, NYSE..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeNewModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Crear Mapeo
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Editar Mapeo -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">‚úèÔ∏è Editar Mapeo</h3>
            <button onclick="closeEditModal()" class="text-gray-600 hover:text-gray-900">‚úï</button>
        </div>
        
        <form id="editForm" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Valor Destino *</label>
                    <input type="text" name="target_value" id="edit_target_value" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s (ISO 2)</label>
                    <input type="text" name="country" id="edit_country" maxlength="2"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                <input type="text" name="description" id="edit_description"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeEditModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal Nuevo
function openNewModal() {
    document.getElementById('newModal').classList.remove('hidden');
}

function closeNewModal() {
    document.getElementById('newModal').classList.add('hidden');
}

// Modal Editar
function editMapping(id, sourceKey, targetValue, description, country) {
    document.getElementById('edit_target_value').value = targetValue;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_country').value = country;
    document.getElementById('editForm').action = `/portfolio/mappings/${id}/edit`;
    document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

// Eliminar
function deleteMapping(id, sourceKey) {
    if (!confirm(`¬øEliminar mapeo ${sourceKey}?\n\nEsta acci√≥n no se puede deshacer.`)) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/portfolio/mappings/${id}/delete`;
    
    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrf_token';
    csrf.value = '{{ csrf_token }}';
    form.appendChild(csrf);
    
    document.body.appendChild(form);
    form.submit();
}

// Toggle activo/inactivo
function toggleMapping(id, sourceKey, isActive) {
    const action = isActive ? 'desactivar' : 'activar';
    if (!confirm(`¬ø${action.charAt(0).toUpperCase() + action.slice(1)} mapeo ${sourceKey}?`)) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/portfolio/mappings/${id}/toggle`;
    
    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrf_token';
    csrf.value = '{{ csrf_token }}';
    form.appendChild(csrf);
    
    document.body.appendChild(form);
    form.submit();
}
</script>

{% endblock %}

