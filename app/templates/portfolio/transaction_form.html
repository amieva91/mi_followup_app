{% extends "base/layout.html" %}

{% block title %}{{ title }} - FollowUp{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <a href="{{ url_for('portfolio.transactions_list') }}" class="text-blue-600 hover:text-blue-700 text-sm font-medium mb-4 inline-block">
            ‚Üê Volver a transacciones
        </a>
        <h1 class="text-3xl font-bold text-gray-900">{{ title }}</h1>
        <p class="text-gray-600 mt-1">Registra una compra o venta con todos los detalles</p>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-xl shadow-sm p-8">
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            
            <!-- Cuenta y Tipo -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    {{ form.account_id.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.account_id(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                    {% if form.account_id.errors %}
                        <div class="mt-1 text-sm text-red-600">{{ form.account_id.errors[0] }}</div>
                    {% endif %}
                </div>

                <div>
                    {{ form.transaction_type.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.transaction_type(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", id="transaction_type") }}
                    {% if form.transaction_type.errors %}
                        <div class="mt-1 text-sm text-red-600">{{ form.transaction_type.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Auto-selecci√≥n SELL (solo visible si tipo = SELL) -->
            <div id="sellSelector" class="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-6" style="display: none;">
                <h3 class="font-semibold text-orange-900 mb-2">üì¶ Seleccionar de Mis Posiciones</h3>
                <p class="text-xs text-orange-700 mb-4">Elige qu√© activo quieres vender de tu cartera actual</p>
                
                <div>
                    <label for="holdingSelector" class="block text-sm font-medium text-gray-700 mb-2">Posici√≥n a vender</label>
                    <select id="holdingSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="">-- Selecciona una posici√≥n --</option>
                    </select>
                    <div id="holdingInfo" class="mt-3 text-sm text-gray-600" style="display: none;">
                        <div class="grid grid-cols-2 gap-2">
                            <div><strong>Cantidad disponible:</strong> <span id="maxQty" class="text-green-600 font-medium"></span></div>
                            <div><strong>Precio actual:</strong> <span id="currentPrice" class="text-blue-600 font-medium"></span></div>
                        </div>
                        <div class="mt-2"><strong>Valor estimado:</strong> <span id="estimatedValue" class="text-purple-600 font-medium text-lg"></span></div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Activo -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <h3 class="font-semibold text-blue-900 mb-4">üìä Informaci√≥n del Activo</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="relative">
                        {{ form.symbol.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.symbol(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: AAPL", id="symbol_input", autocomplete="off") }}
                        {% if form.symbol.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.symbol.errors[0] }}</div>
                        {% endif %}
                        <!-- Dropdown de autocompletado -->
                        <div id="autocompleteDropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto" style="display: none;">
                            <!-- Las sugerencias se insertan aqu√≠ -->
                        </div>
                    </div>

                    <div>
                        {{ form.isin.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.isin(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Opcional") }}
                        {% if form.isin.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.isin.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.currency.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.currency(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                        {% if form.currency.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.currency.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        {{ form.asset_name.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.asset_name(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: Apple Inc.") }}
                        {% if form.asset_name.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.asset_name.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.asset_type.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.asset_type(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                        {% if form.asset_type.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.asset_type.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Identificadores de Mercado -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                <h3 class="font-semibold text-purple-900 mb-2">üåê Identificadores de Mercado</h3>
                <p class="text-xs text-purple-700 mb-4">Opcionales - Se autocompletar√°n al importar CSVs o enriquecer con OpenFIGI</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        {{ form.exchange.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.exchange(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent", placeholder="Ej: NASDAQ, BM") }}
                        <p class="mt-1 text-xs text-gray-500">Formato IBKR</p>
                        {% if form.exchange.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.exchange.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.mic.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.mic(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent", placeholder="Ej: XMAD, XNAS", maxlength="4") }}
                        <p class="mt-1 text-xs text-gray-500">4 caracteres</p>
                        {% if form.mic.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.mic.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.yahoo_suffix.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.yahoo_suffix(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent", placeholder="Ej: .MC, .L (vac√≠o si US)") }}
                        <p class="mt-1 text-xs text-gray-500">Para Yahoo Finance</p>
                        {% if form.yahoo_suffix.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.yahoo_suffix.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Botones de Enriquecimiento Manual -->
                <div class="mt-4 pt-4 border-t border-purple-300">
                    <p class="text-xs text-purple-700 mb-3">üîç Si faltan datos, puedes completarlos manualmente:</p>
                    
                    <!-- Bot√≥n OpenFIGI -->
                    <div class="mb-4">
                        <button type="button" id="enrichOpenFIGI" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm w-full" {% if action != 'edit' %}disabled title="Solo disponible al editar transacciones existentes"{% endif %}>
                            ü§ñ Enriquecer con OpenFIGI
                        </button>
                        {% if action != 'edit' %}
                        <p class="text-xs text-gray-500 mt-1">Este bot√≥n solo funciona al editar transacciones existentes</p>
                        {% endif %}
                    </div>
                    
                    <!-- Campo + Bot√≥n Yahoo (siempre disponible) -->
                    <div class="space-y-2">
                        <label for="yahooUrlInput" class="block text-xs font-medium text-gray-700">
                            üåê URL de Yahoo Finance (opcional)
                        </label>
                        <div class="flex gap-2">
                            <input 
                                type="url" 
                                id="yahooUrlInput" 
                                placeholder="https://finance.yahoo.com/quote/AAPL/" 
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            />
                            <button type="button" id="enrichYahoo" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm whitespace-nowrap">
                                Enriquecer
                            </button>
                        </div>
                        <p class="text-xs text-gray-500">Busca el asset en Yahoo Finance y pega la URL completa aqu√≠</p>
                    </div>
                    
                    <div id="enrichmentResult" class="mt-3"></div>
                </div>
            </div>

            <!-- Detalles de la Transacci√≥n -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                <h3 class="font-semibold text-green-900 mb-4">üí∞ Detalles de la Transacci√≥n</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        {{ form.transaction_date.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.transaction_date(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", type="date") }}
                        {% if form.transaction_date.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.transaction_date.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.quantity.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        <div class="flex gap-2">
                            {{ form.quantity(class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: 10", type="number", step="0.0001", id="quantity_input") }}
                            <button type="button" id="maxButton" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium whitespace-nowrap" style="display: none;">
                                M√°ximo
                            </button>
                        </div>
                        {% if form.quantity.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.quantity.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.price.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.price(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: 150.50 (o 0 para quiebras)", type="number", step="0.01", min="0") }}
                        {% if form.price.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.price.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        {{ form.commission.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.commission(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="0.00", type="number", step="0.01") }}
                        <p class="mt-1 text-xs text-gray-500">Comisi√≥n del broker</p>
                        {% if form.commission.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.commission.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.fees.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.fees(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="0.00", type="number", step="0.01") }}
                        <p class="mt-1 text-xs text-gray-500">Otros gastos</p>
                        {% if form.fees.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.fees.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.tax.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.tax(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="0.00", type="number", step="0.01") }}
                        <p class="mt-1 text-xs text-gray-500">Impuestos/retenci√≥n</p>
                        {% if form.tax.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.tax.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notas -->
            <div class="mb-6">
                {{ form.notes.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                {{ form.notes(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", rows="3", placeholder="Notas adicionales (opcional)") }}
                {% if form.notes.errors %}
                    <div class="mt-1 text-sm text-red-600">{{ form.notes.errors[0] }}</div>
                {% endif %}
            </div>

            <!-- Botones -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <a href="{{ url_for('portfolio.transactions_list') }}" class="text-gray-600 hover:text-gray-700 font-medium">
                    Cancelar
                </a>
                {{ form.submit(class="btn-primary cursor-pointer") }}
            </div>
        </form>
    </div>

    <!-- Script para c√°lculo en tiempo real -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.querySelector('input[name="quantity"]');
            const priceInput = document.querySelector('input[name="price"]');
            const commissionInput = document.querySelector('input[name="commission"]');
            const feesInput = document.querySelector('input[name="fees"]');
            const taxInput = document.querySelector('input[name="tax"]');
            
            function calculateTotal() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const commission = parseFloat(commissionInput.value) || 0;
                const fees = parseFloat(feesInput.value) || 0;
                const tax = parseFloat(taxInput.value) || 0;
                
                const subtotal = quantity * price;
                const total = subtotal + commission + fees + tax;
                
                return {subtotal, total};
            }
            
            // Se podr√≠a a√±adir un preview del c√°lculo aqu√≠
        });
        
        // --- ENRIQUECIMIENTO MANUAL ---
        // ============================================================
        // ENRIQUECIMIENTO MANUAL
        // ============================================================
        const enrichResult = document.getElementById('enrichmentResult');
        
        {% if action == 'edit' and transaction and transaction.asset %}
        // Bot√≥n OpenFIGI (solo en edici√≥n)
        const assetId = {{ transaction.asset.id }};
        
        document.getElementById('enrichOpenFIGI').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = '‚è≥ Consultando OpenFIGI...';
            enrichResult.innerHTML = '<p class="text-sm text-gray-600">Consultando OpenFIGI...</p>';
            
            try {
                // Obtener CSRF token del formulario
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                
                const response = await fetch(`/portfolio/asset/${assetId}/enrich-manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'csrf_token': csrfToken,
                        'method': 'openfigi'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar campos del asset en el formulario (si existen)
                    const exchangeField = document.querySelector('input[name="exchange"]');
                    const micField = document.querySelector('input[name="mic"]');
                    const yahooField = document.querySelector('input[name="yahoo_suffix"]');
                    
                    if (exchangeField && data.exchange) exchangeField.value = data.exchange;
                    if (micField && data.mic) micField.value = data.mic;
                    if (yahooField && data.yahoo_suffix) yahooField.value = data.yahoo_suffix;
                    
                    // Mostrar resultado detallado
                    enrichResult.innerHTML = `
                        <div class="bg-green-100 border border-green-300 rounded-lg p-3">
                            <p class="text-sm font-semibold text-green-800 mb-1">‚úÖ Asset enriquecido correctamente</p>
                            <ul class="text-xs text-green-700 space-y-1">
                                <li><strong>Symbol:</strong> ${data.symbol || '-'}</li>
                                <li><strong>Exchange:</strong> ${data.exchange || '-'}</li>
                                <li><strong>MIC:</strong> ${data.mic || '-'}</li>
                                <li><strong>Yahoo:</strong> ${data.yahoo_ticker || '-'}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    enrichResult.innerHTML = `<p class="text-sm text-red-600">‚ùå ${data.error}</p>`;
                }
            } catch (error) {
                enrichResult.innerHTML = `<p class="text-sm text-red-600">‚ùå Error: ${error.message}</p>`;
            } finally {
                this.disabled = false;
                this.textContent = 'ü§ñ Enriquecer con OpenFIGI';
            }
        });
        {% endif %}
        
        // Bot√≥n Yahoo URL (funciona tanto en new como en edit)
        document.getElementById('enrichYahoo').addEventListener('click', async function() {
            const yahooUrlInput = document.getElementById('yahooUrlInput');
            const yahooUrl = yahooUrlInput.value.trim();
            
            if (!yahooUrl) {
                enrichResult.innerHTML = '<p class="text-sm text-red-600">‚ùå Por favor, pega una URL de Yahoo Finance primero</p>';
                return;
            }
            
            this.disabled = true;
            this.textContent = '‚è≥ Procesando...';
            enrichResult.innerHTML = '<p class="text-sm text-gray-600">Extrayendo datos...</p>';
            
            try {
                // Parsear URL de Yahoo Finance
                // Formato: https://finance.yahoo.com/quote/AAPL/ o https://es.finance.yahoo.com/quote/GRF.MC/
                const urlMatch = yahooUrl.match(/quote\/([^\/\?]+)/);
                
                if (!urlMatch) {
                    enrichResult.innerHTML = '<p class="text-sm text-red-600">‚ùå URL inv√°lida. Formato esperado: https://finance.yahoo.com/quote/SYMBOL/</p>';
                    return;
                }
                
                const fullSymbol = urlMatch[1];  // Ejemplo: "AAPL" o "GRF.MC"
                const parts = fullSymbol.split('.');
                const symbol = parts[0];
                const yahooSuffix = parts.length > 1 ? '.' + parts.slice(1).join('.') : '';
                
                // Actualizar campos del formulario
                const symbolField = document.querySelector('input[name="symbol"]');
                const yahooField = document.querySelector('input[name="yahoo_suffix"]');
                
                if (symbolField) symbolField.value = symbol;
                if (yahooField) yahooField.value = yahooSuffix;
                
                enrichResult.innerHTML = `
                    <div class="text-sm text-green-600">
                        ‚úÖ Datos extra√≠dos:
                        <ul class="ml-4 mt-1 list-disc">
                            <li><strong>Symbol:</strong> ${symbol}</li>
                            <li><strong>Yahoo Suffix:</strong> ${yahooSuffix || '(vac√≠o - USA)'}</li>
                        </ul>
                    </div>
                `;
                
                // Si estamos en modo edici√≥n y hay assetId, tambi√©n actualizar en BD
                {% if action == 'edit' and transaction %}
                const assetId = {{ transaction.asset_id }};
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                
                const response = await fetch(`/portfolio/asset/${assetId}/enrich-manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'csrf_token': csrfToken,
                        'method': 'yahoo',
                        'yahoo_url': yahooUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar campos adicionales si los devuelve el backend
                    const exchangeField = document.querySelector('input[name="exchange"]');
                    const micField = document.querySelector('input[name="mic"]');
                    
                    if (exchangeField && data.exchange) exchangeField.value = data.exchange;
                    if (micField && data.mic) micField.value = data.mic;
                    
                    enrichResult.innerHTML += `
                        <div class="mt-2 text-sm text-blue-600">
                            üíæ Tambi√©n actualizado en base de datos
                        </div>
                    `;
                } else {
                    enrichResult.innerHTML += `<p class="mt-2 text-sm text-red-600">‚ùå Error en BD: ${data.error}</p>`;
                }
                {% endif %}
            } catch (error) {
                enrichResult.innerHTML = `<p class="text-sm text-red-600">‚ùå Error: ${error.message}</p>`;
            } finally {
                this.disabled = false;
                this.textContent = 'Enriquecer';
            }
        });

        // ============================================================
        // AUTO-SELECCI√ìN SELL: Cargar holdings del usuario
        // ============================================================
        const transactionTypeSelect = document.getElementById('transaction_type');
        const accountSelect = document.querySelector('select[name="account_id"]');
        const sellSelectorDiv = document.getElementById('sellSelector');
        const holdingSelectorSelect = document.getElementById('holdingSelector');
        const holdingInfoDiv = document.getElementById('holdingInfo');
        const maxButton = document.getElementById('maxButton');
        
        let holdings_data = [];
        let selected_holding = null;

        // Mostrar/ocultar selector SELL seg√∫n tipo de transacci√≥n
        transactionTypeSelect.addEventListener('change', function() {
            if (this.value === 'SELL') {
                sellSelectorDiv.style.display = 'block';
                maxButton.style.display = 'inline-block';
                loadUserHoldings();
            } else {
                sellSelectorDiv.style.display = 'none';
                holdingInfoDiv.style.display = 'none';
                maxButton.style.display = 'none';
                selected_holding = null;
            }
        });

        // Recargar holdings cuando cambie la cuenta (para filtrar)
        accountSelect.addEventListener('change', function() {
            if (transactionTypeSelect.value === 'SELL') {
                loadUserHoldings();
                holdingInfoDiv.style.display = 'none';
                selected_holding = null;
            }
        });

        // Cargar holdings desde API
        async function loadUserHoldings() {
            try {
                // Obtener cuenta seleccionada (vac√≠o = todas las cuentas)
                const selectedAccount = accountSelect.value;
                const url = selectedAccount && selectedAccount !== '' 
                    ? `/portfolio/api/holdings?account_id=${selectedAccount}` 
                    : '/portfolio/api/holdings';
                
                console.log('Loading holdings from:', url);  // Debug
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Holdings API response:', data);  // Debug
                
                if (data.success) {
                    holdings_data = data.holdings;
                    
                    // Limpiar y rellenar dropdown
                    holdingSelectorSelect.innerHTML = '<option value="">-- Selecciona una posici√≥n --</option>';
                    
                    if (holdings_data.length === 0) {
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = data.message || '(No hay posiciones disponibles)';
                        holdingSelectorSelect.appendChild(option);
                    } else {
                        holdings_data.forEach((h, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            // Mostrar broker si no hay cuenta espec√≠fica seleccionada
                            const displayText = selectedAccount && selectedAccount !== ''
                                ? `${h.symbol} - ${h.name} (${h.quantity.toFixed(4)})`
                                : `[${h.broker}] ${h.symbol} - ${h.name} (${h.quantity.toFixed(4)})`;
                            option.textContent = displayText;
                            holdingSelectorSelect.appendChild(option);
                        });
                    }
                } else {
                    console.error('API error:', data.error);
                    if (data.traceback) {
                        console.error('Traceback:', data.traceback);
                    }
                    alert(`Error cargando holdings: ${data.error}`);
                }
            } catch (error) {
                console.error('Error loading holdings:', error);
                alert(`Error de red: ${error.message}`);
            }
        }

        // Al seleccionar un holding, auto-rellenar campos
        holdingSelectorSelect.addEventListener('change', function() {
            const index = this.value;
            
            if (index === '') {
                holdingInfoDiv.style.display = 'none';
                selected_holding = null;
                return;
            }
            
            selected_holding = holdings_data[index];
            
            // Mostrar informaci√≥n del holding
            document.getElementById('maxQty').textContent = selected_holding.quantity.toFixed(4);
            document.getElementById('currentPrice').textContent = `${selected_holding.current_price.toFixed(2)} ${selected_holding.currency}`;
            
            const estimatedValue = selected_holding.quantity * selected_holding.current_price;
            document.getElementById('estimatedValue').textContent = `${estimatedValue.toFixed(2)} ${selected_holding.currency}`;
            
            holdingInfoDiv.style.display = 'block';
            
            // Auto-rellenar campos del formulario
            document.querySelector('input[name="symbol"]').value = selected_holding.symbol;
            document.querySelector('input[name="isin"]').value = selected_holding.isin || '';
            document.querySelector('select[name="currency"]').value = selected_holding.currency;
            document.querySelector('input[name="asset_name"]').value = selected_holding.name;
            document.querySelector('select[name="asset_type"]').value = selected_holding.asset_type || 'Stock';
            document.querySelector('input[name="exchange"]').value = selected_holding.exchange || '';
            document.querySelector('input[name="mic"]').value = selected_holding.mic || '';
            document.querySelector('input[name="yahoo_suffix"]').value = selected_holding.yahoo_suffix || '';
            document.querySelector('input[name="price"]').value = selected_holding.current_price.toFixed(2);
            
            // Auto-seleccionar la cuenta del holding
            if (selected_holding.account_id) {
                accountSelect.value = selected_holding.account_id;
            }
        });

        // Bot√≥n "M√°ximo": rellenar cantidad m√°xima
        maxButton.addEventListener('click', function() {
            if (selected_holding) {
                document.getElementById('quantity_input').value = selected_holding.quantity.toFixed(4);
            }
        });

        // Inicializar si ya est√° en modo SELL
        if (transactionTypeSelect.value === 'SELL') {
            sellSelectorDiv.style.display = 'block';
            maxButton.style.display = 'inline-block';
            loadUserHoldings();
        }

        // ============================================================
        // AUTOCOMPLETADO BUY: Buscar en AssetRegistry
        // ============================================================
        const symbolInput = document.getElementById('symbol_input');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        
        let autocomplete_timeout = null;
        let autocomplete_controller = null;

        // Escuchar cambios en el input de Symbol (con debounce)
        symbolInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Cancelar b√∫squeda anterior si existe
            if (autocomplete_timeout) {
                clearTimeout(autocomplete_timeout);
            }
            
            // Si query < 2 caracteres, ocultar dropdown
            if (query.length < 2) {
                autocompleteDropdown.style.display = 'none';
                return;
            }
            
            // Solo buscar en modo BUY
            if (transactionTypeSelect.value !== 'BUY') {
                return;
            }
            
            // Debounce: esperar 300ms despu√©s de dejar de escribir
            autocomplete_timeout = setTimeout(() => {
                searchAssets(query);
            }, 300);
        });

        // Buscar assets en API
        async function searchAssets(query) {
            try {
                // Cancelar request anterior si existe
                if (autocomplete_controller) {
                    autocomplete_controller.abort();
                }
                
                autocomplete_controller = new AbortController();
                
                const response = await fetch(`/portfolio/api/assets/search?q=${encodeURIComponent(query)}`, {
                    signal: autocomplete_controller.signal
                });
                
                const data = await response.json();
                
                if (data.success && data.results.length > 0) {
                    // Mostrar sugerencias
                    autocompleteDropdown.innerHTML = '';
                    
                    data.results.forEach(asset => {
                        const item = document.createElement('div');
                        item.className = 'px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0';
                        item.innerHTML = `
                            <div class="font-medium text-gray-900">${asset.symbol} - ${asset.name}</div>
                            <div class="text-xs text-gray-500">${asset.isin || 'Sin ISIN'} ‚Ä¢ ${asset.asset_type}</div>
                        `;
                        
                        item.addEventListener('click', () => {
                            selectAsset(asset);
                        });
                        
                        autocompleteDropdown.appendChild(item);
                    });
                    
                    autocompleteDropdown.style.display = 'block';
                } else {
                    autocompleteDropdown.style.display = 'none';
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error searching assets:', error);
                }
            }
        }

        // Seleccionar asset del dropdown
        function selectAsset(asset) {
            // Rellenar campos
            document.querySelector('input[name="symbol"]').value = asset.symbol;
            document.querySelector('input[name="isin"]').value = asset.isin || '';
            document.querySelector('input[name="asset_name"]').value = asset.name;
            document.querySelector('select[name="asset_type"]').value = asset.asset_type || 'Stock';
            document.querySelector('select[name="currency"]').value = asset.currency || 'USD';
            document.querySelector('input[name="exchange"]').value = asset.exchange || '';
            document.querySelector('input[name="mic"]').value = asset.mic || '';
            document.querySelector('input[name="yahoo_suffix"]').value = asset.yahoo_suffix || '';
            
            // Ocultar dropdown
            autocompleteDropdown.style.display = 'none';
        }

        // Ocultar dropdown al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!symbolInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                autocompleteDropdown.style.display = 'none';
            }
        });

        // Ocultar dropdown al presionar ESC
        symbolInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                autocompleteDropdown.style.display = 'none';
            }
        });
    </script>
</div>
{% endblock %}

