{% extends "base/layout.html" %}

{% block title %}{{ title }} - FollowUp{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <a href="{{ url_for('portfolio.transactions_list') }}" class="text-blue-600 hover:text-blue-700 text-sm font-medium mb-4 inline-block">
            ‚Üê Volver a transacciones
        </a>
        <h1 class="text-3xl font-bold text-gray-900">{{ title }}</h1>
        <p class="text-gray-600 mt-1">Registra una compra o venta con todos los detalles</p>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-xl shadow-sm p-8">
        <form method="POST" action="">
            {{ form.hidden_tag() }}
            
            <!-- Cuenta y Tipo -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    {{ form.account_id.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.account_id(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                    {% if form.account_id.errors %}
                        <div class="mt-1 text-sm text-red-600">{{ form.account_id.errors[0] }}</div>
                    {% endif %}
                </div>

                <div>
                    {{ form.transaction_type.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                    {{ form.transaction_type(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                    {% if form.transaction_type.errors %}
                        <div class="mt-1 text-sm text-red-600">{{ form.transaction_type.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Informaci√≥n del Activo -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <h3 class="font-semibold text-blue-900 mb-4">üìä Informaci√≥n del Activo</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        {{ form.symbol.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.symbol(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: AAPL") }}
                        {% if form.symbol.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.symbol.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.isin.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.isin(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Opcional") }}
                        {% if form.isin.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.isin.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.currency.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.currency(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                        {% if form.currency.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.currency.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        {{ form.asset_name.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.asset_name(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: Apple Inc.") }}
                        {% if form.asset_name.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.asset_name.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.asset_type.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.asset_type(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                        {% if form.asset_type.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.asset_type.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Identificadores de Mercado -->
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                <h3 class="font-semibold text-purple-900 mb-2">üåê Identificadores de Mercado</h3>
                <p class="text-xs text-purple-700 mb-4">Opcionales - Se autocompletar√°n al importar CSVs o enriquecer con OpenFIGI</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        {{ form.exchange.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.exchange(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent", placeholder="Ej: NASDAQ, BM") }}
                        <p class="mt-1 text-xs text-gray-500">Formato IBKR</p>
                        {% if form.exchange.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.exchange.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.mic.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.mic(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent", placeholder="Ej: XMAD, XNAS", maxlength="4") }}
                        <p class="mt-1 text-xs text-gray-500">4 caracteres</p>
                        {% if form.mic.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.mic.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.yahoo_suffix.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.yahoo_suffix(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent", placeholder="Ej: .MC, .L (vac√≠o si US)") }}
                        <p class="mt-1 text-xs text-gray-500">Para Yahoo Finance</p>
                        {% if form.yahoo_suffix.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.yahoo_suffix.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Botones de Enriquecimiento Manual -->
                {% if action == 'edit' %}
                <div class="mt-4 pt-4 border-t border-purple-300">
                    <p class="text-xs text-purple-700 mb-3">üîç Si faltan datos, puedes enriquecerlos manualmente:</p>
                    
                    <!-- Bot√≥n OpenFIGI -->
                    <div class="mb-4">
                        <button type="button" id="enrichOpenFIGI" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm w-full">
                            ü§ñ Enriquecer con OpenFIGI
                        </button>
                    </div>
                    
                    <!-- Campo + Bot√≥n Yahoo -->
                    <div class="space-y-2">
                        <label for="yahooUrlInput" class="block text-xs font-medium text-gray-700">
                            üåê URL de Yahoo Finance (opcional)
                        </label>
                        <div class="flex gap-2">
                            <input 
                                type="url" 
                                id="yahooUrlInput" 
                                placeholder="https://finance.yahoo.com/quote/AAPL/" 
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            />
                            <button type="button" id="enrichYahoo" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm whitespace-nowrap">
                                Enriquecer
                            </button>
                        </div>
                        <p class="text-xs text-gray-500">Busca el asset en Yahoo Finance y pega la URL completa aqu√≠</p>
                    </div>
                    
                    <div id="enrichmentResult" class="mt-3"></div>
                </div>
                {% endif %}
            </div>

            <!-- Detalles de la Transacci√≥n -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                <h3 class="font-semibold text-green-900 mb-4">üí∞ Detalles de la Transacci√≥n</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        {{ form.transaction_date.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.transaction_date(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", type="date") }}
                        {% if form.transaction_date.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.transaction_date.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.quantity.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.quantity(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: 10", type="number", step="0.0001") }}
                        {% if form.quantity.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.quantity.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.price.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.price(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Ej: 150.50", type="number", step="0.01") }}
                        {% if form.price.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.price.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        {{ form.commission.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.commission(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="0.00", type="number", step="0.01") }}
                        <p class="mt-1 text-xs text-gray-500">Comisi√≥n del broker</p>
                        {% if form.commission.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.commission.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.fees.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.fees(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="0.00", type="number", step="0.01") }}
                        <p class="mt-1 text-xs text-gray-500">Otros gastos</p>
                        {% if form.fees.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.fees.errors[0] }}</div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.tax.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                        {{ form.tax(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="0.00", type="number", step="0.01") }}
                        <p class="mt-1 text-xs text-gray-500">Impuestos/retenci√≥n</p>
                        {% if form.tax.errors %}
                            <div class="mt-1 text-sm text-red-600">{{ form.tax.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notas -->
            <div class="mb-6">
                {{ form.notes.label(class="block text-sm font-medium text-gray-700 mb-2") }}
                {{ form.notes(class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent", rows="3", placeholder="Notas adicionales (opcional)") }}
                {% if form.notes.errors %}
                    <div class="mt-1 text-sm text-red-600">{{ form.notes.errors[0] }}</div>
                {% endif %}
            </div>

            <!-- Botones -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <a href="{{ url_for('portfolio.transactions_list') }}" class="text-gray-600 hover:text-gray-700 font-medium">
                    Cancelar
                </a>
                {{ form.submit(class="btn-primary cursor-pointer") }}
            </div>
        </form>
    </div>

    <!-- Script para c√°lculo en tiempo real -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.querySelector('input[name="quantity"]');
            const priceInput = document.querySelector('input[name="price"]');
            const commissionInput = document.querySelector('input[name="commission"]');
            const feesInput = document.querySelector('input[name="fees"]');
            const taxInput = document.querySelector('input[name="tax"]');
            
            function calculateTotal() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const commission = parseFloat(commissionInput.value) || 0;
                const fees = parseFloat(feesInput.value) || 0;
                const tax = parseFloat(taxInput.value) || 0;
                
                const subtotal = quantity * price;
                const total = subtotal + commission + fees + tax;
                
                return {subtotal, total};
            }
            
            // Se podr√≠a a√±adir un preview del c√°lculo aqu√≠
        });
        
        // --- ENRIQUECIMIENTO MANUAL ---
        {% if action == 'edit' and transaction and transaction.asset %}
        const assetId = {{ transaction.asset.id }};
        const enrichResult = document.getElementById('enrichmentResult');
        
        // Bot√≥n OpenFIGI
        document.getElementById('enrichOpenFIGI').addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = '‚è≥ Consultando OpenFIGI...';
            enrichResult.innerHTML = '<p class="text-sm text-gray-600">Consultando OpenFIGI...</p>';
            
            try {
                // Obtener CSRF token del formulario
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                
                const response = await fetch(`/portfolio/asset/${assetId}/enrich-manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'csrf_token': csrfToken,
                        'method': 'openfigi'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar campos del asset en el formulario (si existen)
                    const exchangeField = document.querySelector('input[name="exchange"]');
                    const micField = document.querySelector('input[name="mic"]');
                    const yahooField = document.querySelector('input[name="yahoo_suffix"]');
                    
                    if (exchangeField && data.exchange) exchangeField.value = data.exchange;
                    if (micField && data.mic) micField.value = data.mic;
                    if (yahooField && data.yahoo_suffix) yahooField.value = data.yahoo_suffix;
                    
                    // Mostrar resultado detallado
                    enrichResult.innerHTML = `
                        <div class="bg-green-100 border border-green-300 rounded-lg p-3">
                            <p class="text-sm font-semibold text-green-800 mb-1">‚úÖ Asset enriquecido correctamente</p>
                            <ul class="text-xs text-green-700 space-y-1">
                                <li><strong>Symbol:</strong> ${data.symbol || '-'}</li>
                                <li><strong>Exchange:</strong> ${data.exchange || '-'}</li>
                                <li><strong>MIC:</strong> ${data.mic || '-'}</li>
                                <li><strong>Yahoo:</strong> ${data.yahoo_ticker || '-'}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    enrichResult.innerHTML = `<p class="text-sm text-red-600">‚ùå ${data.error}</p>`;
                }
            } catch (error) {
                enrichResult.innerHTML = `<p class="text-sm text-red-600">‚ùå Error: ${error.message}</p>`;
            } finally {
                this.disabled = false;
                this.textContent = 'ü§ñ Enriquecer con OpenFIGI';
            }
        });
        
        // Bot√≥n Yahoo URL
        document.getElementById('enrichYahoo').addEventListener('click', async function() {
            const yahooUrlInput = document.getElementById('yahooUrlInput');
            const yahooUrl = yahooUrlInput.value.trim();
            
            if (!yahooUrl) {
                enrichResult.innerHTML = '<p class="text-sm text-red-600">‚ùå Por favor, pega una URL de Yahoo Finance primero</p>';
                return;
            }
            
            this.disabled = true;
            this.textContent = '‚è≥ Procesando...';
            enrichResult.innerHTML = '<p class="text-sm text-gray-600">Procesando URL...</p>';
            
            try {
                // Obtener CSRF token del formulario
                const csrfToken = document.querySelector('input[name="csrf_token"]').value;
                
                const response = await fetch(`/portfolio/asset/${assetId}/enrich-manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'csrf_token': csrfToken,
                        'method': 'yahoo',
                        'yahoo_url': yahooUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar campos del asset en el formulario (si existen)
                    const exchangeField = document.querySelector('input[name="exchange"]');
                    const micField = document.querySelector('input[name="mic"]');
                    const yahooField = document.querySelector('input[name="yahoo_suffix"]');
                    
                    if (exchangeField && data.exchange) exchangeField.value = data.exchange;
                    if (micField && data.mic) micField.value = data.mic;
                    if (yahooField && data.yahoo_suffix) yahooField.value = data.yahoo_suffix;
                    
                    // Limpiar el campo de URL
                    yahooUrlInput.value = '';
                    
                    // Mostrar resultado detallado
                    enrichResult.innerHTML = `
                        <div class="bg-green-100 border border-green-300 rounded-lg p-3">
                            <p class="text-sm font-semibold text-green-800 mb-1">‚úÖ Asset actualizado desde Yahoo Finance</p>
                            <ul class="text-xs text-green-700 space-y-1">
                                <li><strong>Symbol:</strong> ${data.symbol || '-'}</li>
                                <li><strong>Exchange:</strong> ${data.exchange || '-'}</li>
                                <li><strong>MIC:</strong> ${data.mic || '-'}</li>
                                <li><strong>Yahoo:</strong> ${data.yahoo_ticker || '-'}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    enrichResult.innerHTML = `<p class="text-sm text-red-600">‚ùå ${data.error}</p>`;
                }
            } catch (error) {
                enrichResult.innerHTML = `<p class="text-sm text-red-600">‚ùå Error: ${error.message}</p>`;
            } finally {
                this.disabled = false;
                this.textContent = 'Enriquecer';
            }
        });
        {% endif %}
    </script>
</div>
{% endblock %}

