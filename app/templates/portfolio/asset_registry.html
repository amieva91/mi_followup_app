{% extends "base/layout.html" %}

{% block title %}Registro Global de Assets{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">üóÑÔ∏è Registro Global de Assets</h1>
            <p class="text-gray-600 mt-1">
                Base de datos compartida de mapeos ISIN ‚Üí Symbol, Exchange, MIC
            </p>
        </div>
        
        <div class="flex gap-3">
            <a href="{{ url_for('portfolio.mappings') }}" 
               class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                üó∫Ô∏è Gestionar Mapeos
            </a>
            <a href="{{ url_for('portfolio.transactions_list') }}" 
               class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                ‚Üê Volver a Transacciones
            </a>
        </div>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="text-sm text-blue-600 font-medium">Total Registros</div>
            <div class="text-2xl font-bold text-blue-900">{{ stats.total }}</div>
        </div>
        
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="text-sm text-green-600 font-medium">Enriquecidos</div>
            <div class="text-2xl font-bold text-green-900">{{ stats.enriched }}</div>
        </div>
        
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <div class="text-sm text-orange-600 font-medium">Pendientes</div>
            <div class="text-2xl font-bold text-orange-900">{{ stats.pending }}</div>
        </div>
        
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <div class="text-sm text-purple-600 font-medium">Completitud</div>
            <div class="text-2xl font-bold text-purple-900">{{ "%.1f"|format(stats.percentage) }}%</div>
        </div>
    </div>
    
    <!-- Filtros y b√∫squeda -->
    <form method="GET" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- B√∫squeda -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">üîç Buscar</label>
                <input type="text" 
                       name="search" 
                       value="{{ request.args.get('search', '') }}"
                       placeholder="ISIN, Symbol, Nombre..."
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            
            <!-- Filtro: Solo sin enriquecer -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">‚ö†Ô∏è Estado</label>
                <label class="flex items-center px-4 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" 
                           name="unenriched_only" 
                           value="1"
                           {% if request.args.get('unenriched_only') %}checked{% endif %}
                           onchange="this.form.submit()"
                           class="mr-2 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                    <span class="text-sm text-gray-700">Solo sin enriquecer</span>
                </label>
            </div>
            
            <!-- Bot√≥n buscar -->
            <div class="flex items-end">
                <button type="submit" 
                        class="w-full px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    Buscar
                </button>
            </div>
        </div>
    </form>
    
    <!-- Tabla de registros -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        {% macro sortable_header(field, label) %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <a href="?sort_by={{ field }}&sort_order={% if sort_by == field and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% if request.args.get('search') %}&search={{ request.args.get('search') }}{% endif %}{% if request.args.get('unenriched_only') %}&unenriched_only=1{% endif %}" 
                               class="hover:text-gray-700 flex items-center gap-1">
                                {{ label }}
                                {% if sort_by == field %}
                                    {% if sort_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        {% endmacro %}
                        
                        {{ sortable_header('isin', 'ISIN') }}
                        {{ sortable_header('symbol', 'Symbol') }}
                        {{ sortable_header('name', 'Nombre') }}
                        {{ sortable_header('currency', 'Moneda') }}
                        {{ sortable_header('exchange', 'Exchange') }}
                        {{ sortable_header('mic', 'MIC') }}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Yahoo</th>
                        {{ sortable_header('is_enriched', 'Estado') }}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <a href="?sort_by=usage_count&sort_order={% if sort_by == 'usage_count' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" 
                               class="hover:text-gray-700 flex items-center gap-1">
                                <span>Uso</span>
                                <span class="cursor-help" title="Contador global: n√∫mero de veces que este activo ha aparecido en importaciones CSV. No se resetea al borrar cuentas.">‚ÑπÔ∏è</span>
                                {% if sort_by == 'usage_count' %}
                                    {% if sort_order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% if registries %}
                        {% for reg in registries %}
                        <tr class="hover:bg-gray-50" id="row-{{ reg.id }}">
                            <!-- ISIN -->
                            <td class="px-4 py-3 text-sm font-mono text-gray-900">
                                {{ reg.isin }}
                            </td>
                            
                            <!-- Symbol -->
                            <td class="px-4 py-3 text-sm">
                                {% if reg.symbol %}
                                    <span class="font-semibold text-blue-900">{{ reg.symbol }}</span>
                                {% else %}
                                    <span class="text-gray-400 italic">sin symbol</span>
                                {% endif %}
                            </td>
                            
                            <!-- Nombre -->
                            <td class="px-4 py-3 text-sm text-gray-700 max-w-xs truncate" title="{{ reg.name }}">
                                {{ reg.name or '-' }}
                            </td>
                            
                            <!-- Moneda -->
                            <td class="px-4 py-3 text-sm text-center">
                                <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded font-medium">
                                    {{ reg.currency }}
                                </span>
                            </td>
                            
                            <!-- Exchange -->
                            <td class="px-4 py-3 text-sm">
                                {% if reg.ibkr_exchange %}
                                    <span class="font-medium text-gray-900">{{ reg.ibkr_exchange }}</span>
                                {% else %}
                                    <span class="text-orange-500 italic">sin exchange</span>
                                {% endif %}
                            </td>
                            
                            <!-- MIC -->
                            <td class="px-4 py-3 text-sm font-mono text-gray-700">
                                {{ reg.mic or '-' }}
                            </td>
                            
                            <!-- Yahoo Ticker -->
                            <td class="px-4 py-3 text-sm">
                                {% if reg.yahoo_ticker %}
                                    <span class="font-mono text-purple-900">{{ reg.yahoo_ticker }}</span>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            
                            <!-- Estado -->
                            <td class="px-4 py-3 text-sm text-center">
                                {% if reg.is_enriched %}
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">
                                        ‚úì {{ reg.enrichment_source or 'OK' }}
                                    </span>
                                {% else %}
                                    <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-medium">
                                        ‚ö†Ô∏è Pendiente
                                    </span>
                                {% endif %}
                            </td>
                            
                            <!-- Usage Count -->
                            <td class="px-4 py-3 text-sm text-center text-gray-700">
                                {{ reg.usage_count }}
                            </td>
                            
                            <!-- Acciones -->
                            <td class="px-4 py-3 text-sm whitespace-nowrap">
                                <button onclick="editRegistry({{ reg.id }})" 
                                        class="text-blue-600 hover:text-blue-900 mr-3">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteRegistry({{ reg.id }}, '{{ reg.isin }}')" 
                                        class="text-red-600 hover:text-red-900">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                                {% if request.args.get('search') or request.args.get('unenriched_only') %}
                                    No se encontraron registros con los filtros aplicados
                                {% else %}
                                    No hay registros en la base de datos global. Importa CSVs para poblarla.
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        {% if registries %}
        <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 text-sm text-gray-700">
            Mostrando {{ registries|length }} registros
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Edici√≥n -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">‚úèÔ∏è Editar Registro</h3>
            <button onclick="closeModal()" class="text-gray-600 hover:text-gray-900">‚úï</button>
        </div>
        
        <form id="editForm" method="POST" class="space-y-4">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Symbol</label>
                    <input type="text" name="symbol" id="edit_symbol" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Exchange (IBKR)</label>
                    <input type="text" name="exchange" id="edit_exchange" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">MIC</label>
                    <input type="text" name="mic" id="edit_mic" maxlength="4"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Yahoo Suffix</label>
                    <input type="text" name="yahoo_suffix" id="edit_yahoo_suffix" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                           placeholder=".MC, .L, etc (vac√≠o si US)">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                    <select name="asset_type" id="edit_asset_type" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="Stock">Stock</option>
                        <option value="ETF">ETF</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input type="text" name="name" id="edit_name" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            
            <!-- Botones de Enriquecimiento -->
            <div class="border-t pt-4 mt-4">
                <!-- OpenFIGI -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üîç</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-1">Enriquecimiento Autom√°tico</h4>
                            <p class="text-sm text-gray-600 mb-3">
                                Consulta OpenFIGI para obtener autom√°ticamente el symbol, exchange, MIC y otros datos.
                            </p>
                            <button type="button" id="enrichButton" onclick="enrichAssetRegistry()" 
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                <span id="enrichButtonText">üîç Enriquecer con OpenFIGI</span>
                            </button>
                            <div id="enrichStatus" class="mt-2 text-sm hidden"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Yahoo Finance URL -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üîß</span>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-1">Correcci√≥n Manual desde Yahoo</h4>
                            <p class="text-sm text-gray-600 mb-3">
                                Pega la URL de Yahoo Finance para extraer autom√°ticamente el symbol y suffix correcto.
                            </p>
                            <div class="flex gap-2">
                                <input type="text" id="yahooUrlInput" placeholder="https://finance.yahoo.com/quote/AAPL/" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <button type="button" onclick="enrichFromYahooUrl()" 
                                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors whitespace-nowrap">
                                    üîó Desde URL
                                </button>
                            </div>
                            <div id="yahooUrlStatus" class="mt-2 text-sm hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="closeModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Variable global para almacenar el ID del registro actual
    let currentRegistryId = null;
    
    function editRegistry(id) {
        // Guardar ID para enriquecimiento
        currentRegistryId = id;
        
        // Obtener datos de la fila
        const row = document.querySelector(`#row-${id}`);
        if (!row) return;
        
        // Cargar datos actuales desde la API
        fetch(`/portfolio/asset-registry`)
            .then(() => {
                // Por ahora, extraer datos del DOM
                const cells = row.querySelectorAll('td');
                const symbol = cells[1].textContent.includes('sin symbol') ? '' : cells[1].textContent.trim();
                const name = cells[2].textContent.trim();
                const exchange = cells[4].textContent.includes('sin exchange') ? '' : cells[4].textContent.trim();
                const mic = cells[5].textContent.trim();
                
                // Rellenar formulario
                document.getElementById('edit_symbol').value = symbol === '-' ? '' : symbol;
                document.getElementById('edit_name').value = name === '-' ? '' : name;
                document.getElementById('edit_exchange').value = exchange === '-' ? '' : exchange;
                document.getElementById('edit_mic').value = mic === '-' ? '' : mic;
                document.getElementById('edit_yahoo_suffix').value = '';
                
                // Actualizar action del formulario
                document.getElementById('editForm').action = `/portfolio/asset-registry/${id}/edit`;
                
                // Reset enrich status
                document.getElementById('enrichStatus').classList.add('hidden');
                document.getElementById('enrichButton').disabled = false;
                document.getElementById('enrichButtonText').textContent = 'üîç Enriquecer con OpenFIGI';
                
                // Mostrar modal
                document.getElementById('editModal').classList.remove('hidden');
            });
    }
    
    function deleteRegistry(id, isin) {
        if (!confirm(`¬øEliminar registro ${isin}?\n\nEsta acci√≥n no se puede deshacer.`)) {
            return;
        }
        
        // Crear formulario temporal
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/portfolio/asset-registry/${id}/delete`;
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrf_token';
        csrf.value = '{{ csrf_token }}';
        form.appendChild(csrf);
        
        document.body.appendChild(form);
        form.submit();
    }
    
    async function enrichAssetRegistry() {
        if (!currentRegistryId) {
            alert('Error: No se ha cargado el ID del registro');
            return;
        }
        
        const button = document.getElementById('enrichButton');
        const buttonText = document.getElementById('enrichButtonText');
        const status = document.getElementById('enrichStatus');
        
        // Deshabilitar bot√≥n y mostrar loading
        button.disabled = true;
        buttonText.textContent = '‚è≥ Consultando OpenFIGI...';
        status.classList.remove('hidden');
        status.className = 'mt-2 text-sm text-blue-600';
        status.textContent = 'Consultando OpenFIGI API...';
        
        try {
            // Obtener CSRF token del formulario
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            
            const response = await fetch(`/portfolio/asset-registry/${currentRegistryId}/enrich`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${csrfToken}`
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Actualizar campos del formulario
                if (result.data.symbol) {
                    document.getElementById('edit_symbol').value = result.data.symbol;
                }
                if (result.data.name) {
                    document.getElementById('edit_name').value = result.data.name;
                }
                if (result.data.exchange) {
                    document.getElementById('edit_exchange').value = result.data.exchange;
                }
                if (result.data.mic) {
                    document.getElementById('edit_mic').value = result.data.mic;
                }
                if (result.data.yahoo_suffix !== null) {
                    document.getElementById('edit_yahoo_suffix').value = result.data.yahoo_suffix;
                }
                if (result.data.asset_type) {
                    document.getElementById('edit_asset_type').value = result.data.asset_type;
                }
                
                // Mostrar √©xito
                status.className = 'mt-2 text-sm text-green-600 font-semibold';
                status.textContent = `‚úÖ ${result.message}`;
                buttonText.textContent = '‚úÖ Enriquecido';
                
                // Informar al usuario que debe guardar
                setTimeout(() => {
                    status.textContent = '‚úÖ Datos actualizados. Haz clic en "Guardar Cambios" para aplicar.';
                }, 1000);
                
            } else {
                // Mostrar error
                status.className = 'mt-2 text-sm text-red-600 font-semibold';
                status.textContent = `‚ùå ${result.error}`;
                button.disabled = false;
                buttonText.textContent = 'üîç Reintentar';
            }
            
        } catch (error) {
            status.className = 'mt-2 text-sm text-red-600 font-semibold';
            status.textContent = `‚ùå Error de conexi√≥n: ${error.message}`;
            button.disabled = false;
            buttonText.textContent = 'üîç Reintentar';
        }
    }
    
    function enrichFromYahooUrl() {
        const yahooUrlInput = document.getElementById('yahooUrlInput');
        const status = document.getElementById('yahooUrlStatus');
        const url = yahooUrlInput.value.trim();
        
        if (!url) {
            status.classList.remove('hidden');
            status.className = 'mt-2 text-sm text-red-600';
            status.textContent = 'Por favor, pega una URL de Yahoo Finance';
            return;
        }
        
        // Extraer symbol de la URL
        // Ejemplos:
        // https://finance.yahoo.com/quote/AAPL ‚Üí AAPL (sin suffix)
        // https://finance.yahoo.com/quote/GRF.MC ‚Üí GRF + .MC
        // https://es.finance.yahoo.com/quote/PSG.MC/ ‚Üí PSG + .MC
        const match = url.match(/\/quote\/([A-Z0-9]+)(\.[A-Z]+)?/i);
        
        if (!match) {
            status.classList.remove('hidden');
            status.className = 'mt-2 text-sm text-red-600';
            status.textContent = '‚ùå URL inv√°lida. Debe ser del formato: https://finance.yahoo.com/quote/SYMBOL';
            return;
        }
        
        const symbol = match[1];
        const suffix = match[2] || ''; // Puede ser .MC, .L, etc., o vac√≠o para US
        
        // Actualizar campos
        document.getElementById('edit_symbol').value = symbol;
        document.getElementById('edit_yahoo_suffix').value = suffix;
        
        // Mostrar √©xito
        status.classList.remove('hidden');
        status.className = 'mt-2 text-sm text-green-600 font-semibold';
        status.textContent = `‚úÖ Extra√≠do: ${symbol}${suffix}`;
        
        // Limpiar input
        yahooUrlInput.value = '';
    }
    
    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
        currentRegistryId = null;
    }
</script>
{% endblock %}

