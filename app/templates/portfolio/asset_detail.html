{% extends "base/layout.html" %}

{% block title %}{{ asset.name }} - FollowUp{% endblock %}

{% block extra_css %}
<style>
/* Estilos para informes Markdown - mejora la legibilidad y jerarqu√≠a visual */
.report-markdown h1, .report-markdown h2, .report-markdown h3, .report-markdown h4 {
    font-weight: 700;
    margin-top: 1.25em;
    margin-bottom: 0.5em;
    line-height: 1.3;
    color: #1e3a8a;
}
.report-markdown h1 { font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.25em; }
.report-markdown h2 { font-size: 1.25rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.2em; }
.report-markdown h3, .report-markdown h4 { font-size: 1.1rem; }
.report-markdown p { margin-bottom: 0.75em; line-height: 1.7; color: #374151; }
.report-markdown ul, .report-markdown ol {
    margin: 0.5em 0 1em 1.25em;
    padding-left: 1em;
}
.report-markdown li { margin-bottom: 0.35em; line-height: 1.6; }
.report-markdown strong { color: #111827; font-weight: 600; }
.report-markdown table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
    font-size: 0.9rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-radius: 8px;
    overflow: hidden;
}
.report-markdown th, .report-markdown td {
    border: 1px solid #e5e7eb;
    padding: 0.6em 0.75em;
    text-align: left;
}
.report-markdown th {
    background: #1e3a8a;
    color: white;
    font-weight: 600;
}
.report-markdown tr:nth-child(even) { background: #f9fafb; }
.report-markdown tr:hover { background: #f3f4f6; }
.report-markdown blockquote {
    border-left: 4px solid #1e3a8a;
    margin: 1em 0;
    padding: 0.5em 1em;
    background: #f0f4ff;
    color: #374151;
    font-style: italic;
}
.report-markdown hr { border: none; border-top: 1px solid #e5e7eb; margin: 1.5em 0; }
.report-markdown code { background: #f3f4f6; padding: 0.15em 0.4em; border-radius: 4px; font-size: 0.9em; }
</style>
{% endblock %}

{% block content %}
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
<div class="max-w-[92%] mx-auto">
    <!-- Header con navegaci√≥n -->
    <div class="mb-6">
        <a href="{{ url_for('portfolio.dashboard') }}" onclick="if (window.history.length > 1) { event.preventDefault(); history.back(); }" class="text-blue-600 hover:text-blue-700 text-sm font-medium inline-flex items-center gap-1 mb-2">
            ‚Üê Volver
        </a>
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ asset.name }}</h1>
                <p class="text-gray-600 mt-1">
                    {{ asset.symbol or 'Sin s√≠mbolo' }} 
                    {% if asset.exchange %} ‚Ä¢ {{ asset.exchange }}{% endif %}
                    ‚Ä¢ {{ asset.currency }}
                    {% if asset.isin %} ‚Ä¢ {{ asset.isin }}{% endif %}
                </p>
            </div>
            <div class="text-right flex flex-col items-end gap-2">
                <button onclick="openReportTemplatesModal()" class="text-sm text-gray-500 hover:text-blue-600 flex items-center gap-1">
                    ‚öôÔ∏è Ajustes de informes
                </button>
                <div>
                    <div class="text-sm text-gray-600">Tipo de Activo</div>
                    <div class="text-lg font-semibold text-gray-900">{{ asset.asset_type }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid de m√©tricas principales -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Card: Precio Actual -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
            <div class="text-sm text-gray-600 mb-1">Precio Actual</div>
            {% if asset.current_price %}
                <div class="text-3xl font-bold text-gray-900">
                    {{ asset.current_price|decimal_eu(2) }} {{ asset.currency }}
                </div>
                {% if asset.day_change_percent %}
                    <div class="text-sm mt-2 {% if asset.day_change_percent > 0 %}text-green-600{% elif asset.day_change_percent < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                        {% if asset.day_change_percent > 0 %}‚Üë{% elif asset.day_change_percent < 0 %}‚Üì{% else %}‚Üí{% endif %} {{ asset.day_change_percent|decimal_eu(2) }}% hoy
                    </div>
                {% endif %}
                {% if asset.last_price_update %}
                    <div class="text-xs text-gray-400 mt-1">
                        Actualizado: {{ asset.last_price_update.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                {% endif %}
            {% else %}
                <div class="text-xl text-gray-400">Sin datos</div>
                <div class="text-xs text-gray-500 mt-1">Actualiza precios para ver los datos</div>
            {% endif %}
        </div>

        <!-- Card: Tus Holdings -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
            <div class="text-sm text-gray-600 mb-1">Tus Holdings</div>
            <div class="text-3xl font-bold text-gray-900">
                {{ total_quantity|number_eu }}
            </div>
            <div class="text-sm text-gray-600 mt-2">
                Precio Medio: {{ average_buy_price|decimal_eu(2) }} {{ asset.currency }}
            </div>
            <div class="text-sm text-gray-600">
                Coste Total: {{ total_cost|decimal_eu(2) }} {{ asset.currency }}
            </div>
        </div>

        <!-- Card: P&L No Realizado -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if unrealized_pl and unrealized_pl >= 0 %}border-green-600{% else %}border-red-600{% endif %}">
            <div class="text-sm text-gray-600 mb-1">P&L No Realizado</div>
            {% if unrealized_pl is not none %}
                <div class="text-3xl font-bold {% if unrealized_pl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    {% if unrealized_pl >= 0 %}+{% endif %}{{ unrealized_pl|decimal_eu(2) }} {{ asset.currency }}
                </div>
                <div class="text-sm mt-2 {% if unrealized_pl_pct >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    {% if unrealized_pl_pct >= 0 %}+{% endif %}{{ unrealized_pl_pct|decimal_eu(2) }}%
                </div>
                {% if current_value %}
                    <div class="text-xs text-gray-500 mt-1">
                        Valor Actual: {{ current_value|decimal_eu(2) }} {{ asset.currency }}
                    </div>
                {% endif %}
            {% else %}
                <div class="text-xl text-gray-400">-</div>
                <div class="text-xs text-gray-500 mt-1">Actualiza precios</div>
            {% endif %}
        </div>
    </div>

    <!-- Tabs de informaci√≥n -->
    <div class="bg-white rounded-xl shadow-sm" x-data="{ activeTab: 'metrics' }">
        <!-- Tab Headers -->
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button @click="activeTab = 'metrics'" 
                        :class="activeTab === 'metrics' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-4 text-sm font-medium border-b-2">
                    üìä Overview
                </button>
                <button @click="activeTab = 'valuation'" 
                        :class="activeTab === 'valuation' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-4 text-sm font-medium border-b-2">
                    üí∞ Valoraci√≥n
                </button>
                <button @click="activeTab = 'risk'" 
                        :class="activeTab === 'risk' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-4 text-sm font-medium border-b-2">
                    üìà Riesgo y Dividendos
                </button>
                <button @click="activeTab = 'analysis'" 
                        :class="activeTab === 'analysis' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-4 text-sm font-medium border-b-2">
                    üéØ An√°lisis
                </button>
                <button @click="activeTab = 'reports'; setTimeout(loadReports, 100)" 
                        :class="activeTab === 'reports' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-4 text-sm font-medium border-b-2">
                    üìÑ Informes
                </button>
                <button @click="activeTab = 'transactions'" 
                        :class="activeTab === 'transactions' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="px-6 py-4 text-sm font-medium border-b-2">
                    üìú Transacciones
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Tab: Overview -->
            <div x-show="activeTab === 'metrics'" x-cloak>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Pa√≠s</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.country or '‚Äî' }}
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Sector</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.sector or '‚Äî' }}
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Industria</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.industry or '‚Äî' }}
                        </div>
                    </div>
                </div>
                <!-- About the Company -->
                <div class="mt-8 border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                        <div class="text-sm font-medium text-gray-700">About the Company</div>
                        {% if gemini_available %}
                        <button id="btnGenerateAbout" onclick="generateAboutSummary()" 
                                class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            Generar resumen
                        </button>
                        {% else %}
                        <span class="text-xs text-gray-400">GEMINI_API_KEY no configurada</span>
                        {% endif %}
                    </div>
                    <div id="aboutSummaryContent" class="text-gray-800 whitespace-pre-wrap min-h-[60px]">
                        {% if about_summary %}{{ about_summary }}{% else %}
                        <span class="text-gray-400">Pulsa "Generar resumen" para obtener una descripci√≥n breve de la compa√±√≠a.</span>
                        {% endif %}
                    </div>
                    <div id="aboutSummaryLoading" class="hidden text-sm text-blue-600">Generando...</div>
                </div>
            </div>

            <!-- Tab: Valoraci√≥n -->
            <div x-show="activeTab === 'valuation'" x-cloak>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Capitalizaci√≥n de Mercado</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.market_cap_formatted or '‚Äî' }}
                        </div>
                        {% if asset.market_cap_eur %}
                            <div class="text-sm text-gray-500 mt-1">
                                {{ asset.market_cap_eur|decimal_eu(0) }} EUR
                            </div>
                        {% endif %}
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">P/E Ratio (Trailing)</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.trailing_pe|decimal_eu(2) if asset.trailing_pe else '‚Äî' }}
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">P/E Ratio (Forward)</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.forward_pe|decimal_eu(2) if asset.forward_pe else '‚Äî' }}
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Moneda Base</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.currency }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Riesgo y Dividendos -->
            <div x-show="activeTab === 'risk'" x-cloak>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Beta</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.beta|decimal_eu(2) if asset.beta else '‚Äî' }}
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Volatilidad vs. mercado
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Dividendo Anual</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.dividend_rate|decimal_eu(2) if asset.dividend_rate else '‚Äî' }} {{ asset.currency if asset.dividend_rate else '' }}
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Rentabilidad por Dividendo</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.dividend_yield|decimal_eu(2) if asset.dividend_yield else '‚Äî' }}{% if asset.dividend_yield %}%{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: An√°lisis -->
            <div x-show="activeTab === 'analysis'" x-cloak>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">Recomendaci√≥n de Analistas</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {% if asset.recommendation_key %}
                                <span class="px-3 py-1 rounded-full text-sm font-medium
                                    {% if asset.recommendation_key == 'strong_buy' %}bg-green-100 text-green-800
                                    {% elif asset.recommendation_key == 'buy' %}bg-green-50 text-green-700
                                    {% elif asset.recommendation_key == 'hold' %}bg-yellow-100 text-yellow-800
                                    {% elif asset.recommendation_key == 'sell' %}bg-red-50 text-red-700
                                    {% elif asset.recommendation_key == 'strong_sell' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ asset.recommendation_key.replace('_', ' ').title() }}
                                </span>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="text-sm text-gray-600 mb-1">N√∫mero de Analistas</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.number_of_analyst_opinions if asset.number_of_analyst_opinions else '‚Äî' }}
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg p-4 md:col-span-2">
                        <div class="text-sm text-gray-600 mb-1">Precio Objetivo Medio</div>
                        <div class="text-lg font-semibold text-gray-900">
                            {{ asset.target_mean_price|decimal_eu(2) if asset.target_mean_price else '‚Äî' }} {{ asset.currency if asset.target_mean_price else '' }}
                        </div>
                        {% if asset.current_price and asset.target_mean_price %}
                            {% set potential = ((asset.target_mean_price - asset.current_price) / asset.current_price * 100) %}
                            <div class="text-sm mt-1 {% if potential > 0 %}text-green-600{% elif potential < 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                                Potencial: {% if potential > 0 %}+{% endif %}{{ potential|decimal_eu(2) }}%
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tab: Informes -->
            <div x-show="activeTab === 'reports'" x-cloak>
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Informes de investigaci√≥n</h3>
                    {% if gemini_available and has_valid_templates %}
                    <div class="flex gap-2">
                        <select id="reportTemplateSelect" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            {% for t in report_templates %}
                            {% if t.has_valid_description() %}
                            <option value="{{ t.id }}">{{ t.title }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <button onclick="generateReport()" id="btnGenerateReport" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Generar informe
                        </button>
                    </div>
                    {% elif gemini_available %}
                    <button disabled title="Crea al menos una plantilla en Ajustes de informes" class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed">
                        Generar informe
                    </button>
                    {% else %}
                    <span class="text-sm text-gray-400">GEMINI_API_KEY no configurada</span>
                    {% endif %}
                </div>
                <div id="reportGenerateLoading" class="hidden mb-4 p-3 bg-blue-50 text-blue-700 rounded-lg text-sm">
                    Generando informe... Puede tardar varios minutos.
                </div>
                <div id="reportsList" class="space-y-3">
                    <!-- Se carga v√≠a JS -->
                </div>
                <div id="reportDetail" class="hidden mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-500" id="reportDetailDate"></span>
                        <button onclick="closeReportDetail()" class="text-gray-500 hover:text-gray-700 text-sm">Cerrar</button>
                    </div>
                    <div id="reportDetailActions" class="flex flex-wrap gap-2 mb-3">
                        <button onclick="sendReportEmail()" id="btnSendReportEmail" class="hidden px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">Enviar por correo</button>
                        <button onclick="generateReportAudio()" id="btnGenerateAudio" class="hidden px-3 py-1.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">Generar audio resumen</button>
                        <button onclick="retryReportAudio()" id="btnRetryAudio" class="hidden px-3 py-1.5 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm">Reintentar audio</button>
                        <span id="reportAudioStatus" class="hidden px-3 py-1.5 rounded-lg text-sm"></span>
                        <a id="btnDownloadAudio" href="#" class="hidden px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm no-underline" download>Descargar audio</a>
                    </div>
                    <div id="reportAudioPlayer" class="hidden mb-3">
                        <p class="text-sm text-gray-600 mb-1">Escuchar audio resumen:</p>
                        <audio id="audioPlayer" controls class="w-full max-w-md" preload="metadata"></audio>
                    </div>
                    <div id="reportDetailContent" class="prose max-w-none report-markdown"></div>
                </div>
            </div>

            <!-- Tab: Transacciones -->
            <div x-show="activeTab === 'transactions'" x-cloak>
                {% if transactions %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Precio</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cuenta</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for txn in transactions %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                        {{ txn.transaction_date.strftime('%d/%m/%Y') }}
                                    </td>
                                    <td class="px-4 py-3 text-sm">
                                        <span class="px-2 py-1 rounded text-xs font-medium
                                            {% if txn.transaction_type == 'BUY' %}bg-green-100 text-green-800
                                            {% elif txn.transaction_type == 'SELL' %}bg-red-100 text-red-800
                                            {% elif txn.transaction_type == 'DIVIDEND' %}bg-blue-100 text-blue-800
                                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {{ txn.transaction_type }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-right text-sm text-gray-900">
                                        {% if txn.quantity %}{{ txn.quantity|number_eu }}{% else %}‚Äî{% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-sm text-gray-900">
                                        {% if txn.price %}{{ txn.price|decimal_eu(2) }} {{ txn.currency }}{% else %}‚Äî{% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-right text-sm text-gray-900">
                                        {{ txn.amount|decimal_eu(2) }} {{ txn.currency }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-900">
                                        {{ txn.account.broker.name }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <a href="{{ url_for('portfolio.transactions_list', symbol=asset.symbol if asset.symbol else asset.isin) }}" 
                           class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                            Ver todas las transacciones ‚Üí
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-8 text-gray-500">
                        No hay transacciones registradas para este activo
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Plantillas de informes -->
<div id="reportTemplatesModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white">
        <h3 class="text-lg font-medium text-gray-900 mb-4">‚öôÔ∏è Plantillas de informes</h3>
        <p class="text-sm text-gray-600 mb-4">Define plantillas con t√≠tulo, descripci√≥n y puntos. Al generar, selecciona la plantilla que quieras usar.</p>
        <div id="templatesList" class="mb-4 space-y-3">
            <!-- Lista de plantillas, cada una expandible para editar -->
        </div>
        <button type="button" onclick="openAddTemplateForm()" class="mb-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
            + Nueva plantilla
        </button>
        <div id="templateFormContainer" class="hidden border-t pt-4">
            <form id="templateForm">
                <input type="hidden" id="templateId" name="template_id" value="">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo de la plantilla *</label>
                    <input type="text" id="templateTitle" class="w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="Ej: An√°lisis competitivo" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n de la investigaci√≥n *</label>
                    <textarea id="templateDescription" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2"
                        placeholder="Ej: Analiza la situaci√≥n competitiva de la empresa..."></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Puntos/preguntas (opcional)</label>
                    <div id="templatePointsContainer" class="space-y-2"></div>
                    <button type="button" onclick="addTemplatePoint()" class="mt-2 text-sm text-blue-600 hover:text-blue-700">+ A√±adir punto</button>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="cancelTemplateForm()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
        <div class="flex justify-end mt-4">
            <button type="button" onclick="closeReportTemplatesModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cerrar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const ASSET_ID = {{ asset.id }};
const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]')?.content || '';

function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
    toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 min-w-[300px] transform transition-all duration-300 translate-x-full opacity-0`;
    toast.innerHTML = `<span class="text-lg">${icon}</span><span class="flex-1">${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); toast.classList.add('translate-x-0', 'opacity-100'); }, 10);
    setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300);
    }, 3500);
}
const API_REPORT_TEMPLATES_URL = "{{ api_report_templates_url|default('/portfolio/api/report-templates') }}" || '/portfolio/api/report-templates';

document.addEventListener('DOMContentLoaded', function() {
    loadReportTemplates();
    document.getElementById('templateForm')?.addEventListener('submit', saveTemplate);
});

function openReportTemplatesModal() {
    document.getElementById('reportTemplatesModal').classList.remove('hidden');
    loadReportTemplates();
}
function closeReportTemplatesModal() {
    document.getElementById('reportTemplatesModal').classList.add('hidden');
    document.getElementById('templateFormContainer').classList.add('hidden');
}

function loadReportTemplates() {
    fetch(API_REPORT_TEMPLATES_URL)
        .then(async function(r) {
            const ct = r.headers.get('Content-Type') || '';
            if (!ct.includes('application/json')) {
                const text = await r.text();
                throw new Error('API devolvi√≥ HTML (status ' + r.status + '). ¬øSesi√≥n caducada? Recarga la p√°gina.');
            }
            return r.json();
        })
        .then(data => {
            const container = document.getElementById('templatesList');
            if (!container) return;
            const templates = data.templates || [];
            container.innerHTML = templates.map(t => `
                <div class="border border-gray-200 rounded-lg p-3 flex justify-between items-start">
                    <div>
                        <span class="font-medium text-gray-900">${(t.title || '').replace(/</g, '&lt;')}</span>
                        <p class="text-xs text-gray-500 mt-1">${(t.description || '').substring(0, 80).replace(/</g, '&lt;')}${(t.description || '').length > 80 ? '...' : ''}</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="editTemplate(${t.id})" class="text-blue-600 hover:text-blue-800 text-sm">‚úèÔ∏è</button>
                        <button onclick="deleteTemplate(${t.id})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('') || '<p class="text-sm text-gray-500">No hay plantillas. Crea una nueva.</p>';
            const sel = document.getElementById('reportTemplateSelect');
            if (sel) {
                const valid = (data.templates || []).filter(t => (t.description || '').trim());
                sel.innerHTML = valid.map(t => `<option value="${t.id}">${(t.title || '').replace(/</g, '&lt;')}</option>`).join('');
            }
        })
        .catch(err => {
            console.error('loadReportTemplates:', err);
            const c = document.getElementById('templatesList');
            if (c) c.innerHTML = '<p class="text-sm text-red-600">Error al cargar: ' + (err.message || err) + '</p>';
        });
}
function openAddTemplateForm() {
    document.getElementById('templateFormContainer').classList.remove('hidden');
    document.getElementById('templateId').value = '';
    document.getElementById('templateTitle').value = '';
    document.getElementById('templateDescription').value = '';
    const pc = document.getElementById('templatePointsContainer');
    pc.innerHTML = '';
    addTemplatePointInput(pc, '');
}
function editTemplate(id) {
    fetch(`${API_REPORT_TEMPLATES_URL}/${id}`)
        .then(async function(r) {
            const ct = r.headers.get('Content-Type') || '';
            if (!ct.includes('application/json')) throw new Error('Respuesta no JSON (status ' + r.status + ')');
            return r.json();
        })
        .then(t => {
            document.getElementById('templateFormContainer').classList.remove('hidden');
            document.getElementById('templateId').value = t.id;
            document.getElementById('templateTitle').value = t.title || '';
            document.getElementById('templateDescription').value = t.description || '';
            const pc = document.getElementById('templatePointsContainer');
            pc.innerHTML = '';
            (t.points || []).forEach((p, i) => addTemplatePointInput(pc, p, i));
            if ((t.points || []).length === 0) addTemplatePointInput(pc, '');
        })
        .catch(err => { console.error('editTemplate:', err); showToast(err.message || 'Error al cargar plantilla', 'error'); });
}
function cancelTemplateForm() {
    document.getElementById('templateFormContainer').classList.add('hidden');
}
function addTemplatePoint() {
    const pc = document.getElementById('templatePointsContainer');
    addTemplatePointInput(pc, '');
}
function addTemplatePointInput(container, value, idx) {
    if (!container) return;
    const div = document.createElement('div');
    div.className = 'flex gap-2';
    div.innerHTML = `
        <input type="text" value="${(value || '').replace(/"/g, '&quot;')}" class="flex-1 border border-gray-300 rounded-lg px-3 py-2" placeholder="Punto o pregunta">
        <button type="button" onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700">‚úï</button>
    `;
    container.appendChild(div);
}
function saveTemplate(e) {
    e.preventDefault();
    const id = document.getElementById('templateId').value;
    const title = document.getElementById('templateTitle').value.trim();
    const desc = document.getElementById('templateDescription').value.trim();
    const points = [];
    document.querySelectorAll('#templatePointsContainer input[type="text"]').forEach(inp => { const v = inp.value.trim(); if (v) points.push(v); });
    if (!title) { showToast('El t√≠tulo es obligatorio', 'error'); return; }
    if (!desc) { showToast('La descripci√≥n es obligatoria', 'error'); return; }
    const url = id ? `${API_REPORT_TEMPLATES_URL}/${id}` : API_REPORT_TEMPLATES_URL;
    const method = id ? 'PUT' : 'POST';
    fetch(url, {
        method, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({ title, description: desc, points })
    })
    .then(async function(r) {
        const ct = r.headers.get('Content-Type') || '';
        if (!ct.includes('application/json')) {
            const text = await r.text();
            throw new Error('El servidor devolvi√≥ HTML en lugar de JSON. ¬øSesi√≥n caducada? Prueba recargar la p√°gina. Status: ' + r.status);
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            cancelTemplateForm();
            loadReportTemplates();
            location.reload();
        } else showToast(data.error || 'Error al guardar', 'error');
    })
    .catch(err => showToast('Error: ' + err.message, 'error'));
}
function deleteTemplate(id) {
    if (!confirm('¬øEliminar esta plantilla?')) return;
    fetch(`${API_REPORT_TEMPLATES_URL}/${id}`, { method: 'DELETE', headers: { 'X-CSRFToken': CSRF_TOKEN } })
        .then(async function(r) {
            const ct = r.headers.get('Content-Type') || '';
            if (!ct.includes('application/json')) throw new Error('Respuesta no JSON (status ' + r.status + ')');
            return r.json();
        })
        .then(data => { if (data.success) { loadReportTemplates(); location.reload(); } else showToast(data.error, 'error'); })
        .catch(err => showToast('Error: ' + (err.message || err), 'error'));
}

function generateAboutSummary() {
    const btn = document.getElementById('btnGenerateAbout');
    const loading = document.getElementById('aboutSummaryLoading');
    const content = document.getElementById('aboutSummaryContent');
    if (btn.disabled) return;
    btn.disabled = true;
    loading.classList.remove('hidden');
    content.innerHTML = '';
    fetch(`/portfolio/asset/${ASSET_ID}/about/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            content.textContent = data.summary;
        } else {
            content.innerHTML = '<span class="text-red-600">' + (data.error || 'Error') + '</span>';
        }
    })
    .catch(err => { content.innerHTML = '<span class="text-red-600">Error: ' + err + '</span>'; })
    .finally(() => {
        btn.disabled = false;
        loading.classList.add('hidden');
    });
}

function generateReport() {
    const btn = document.getElementById('btnGenerateReport');
    const loading = document.getElementById('reportGenerateLoading');
    const sel = document.getElementById('reportTemplateSelect');
    if (!btn || btn.disabled) return;
    const templateId = sel ? parseInt(sel.value, 10) : null;
    if (!templateId) { showToast('Selecciona una plantilla', 'error'); return; }
    btn.disabled = true;
    loading.classList.remove('hidden');
    fetch(`/portfolio/asset/${ASSET_ID}/reports/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({ template_id: templateId })
    })
    .then(async function(r) {
        const contentType = r.headers.get('Content-Type') || '';
        if (!contentType.includes('application/json')) {
            const text = await r.text();
            throw new Error(r.status + ' ' + (text.slice(0, 100) || r.statusText));
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            loading.innerHTML = 'Generando informe... Puede tardar varios minutos. <span class="ml-2">ID: ' + data.report_id + '</span>';
            pollReportStatus(data.report_id);
        } else {
            showToast(data.error || 'Error', 'error');
            btn.disabled = false;
            loading.classList.add('hidden');
        }
    })
    .catch(err => {
        showToast('Error: ' + (err.message || err), 'error');
        btn.disabled = false;
        loading.classList.add('hidden');
    });
}
function pollReportStatus(reportId) {
    const loading = document.getElementById('reportGenerateLoading');
    const btn = document.getElementById('btnGenerateReport');
    const interval = setInterval(() => {
        fetch(`/portfolio/api/reports/${reportId}/status`)
            .then(r => r.json())
            .then(data => {
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(interval);
                    loading.classList.add('hidden');
                    if (btn) btn.disabled = false;
                    loadReports();
                    if (data.status === 'completed') loadReportDetail(reportId);
                }
            });
    }, 5000);
}

function loadReports() {
    fetch(`/portfolio/asset/${ASSET_ID}/reports`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('reportsList');
            if (!container) return;
            if (!data.reports || data.reports.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No hay informes. Pulsa "Generar informe" para crear uno.</p>';
                return;
            }
            container.innerHTML = data.reports.map(r => {
                const date = r.completed_at ? new Date(r.completed_at).toLocaleDateString('es-ES') : (r.created_at ? new Date(r.created_at).toLocaleDateString('es-ES') : '');
                const statusBadge = r.status === 'completed' ? 'bg-green-100 text-green-800' : r.status === 'failed' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                const name = r.template_title || ('Informe ' + r.id);
                const audioBadge = r.audio_status === 'completed' ? ' <span class="text-green-600" title="Audio disponible">üîä</span>' : r.audio_status === 'processing' ? ' <span class="text-yellow-600" title="Generando audio...">‚è≥</span>' : '';
                return `
                    <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="loadReportDetail(${r.id})">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium">${(name || '').replace(/</g, '&lt;')}${audioBadge}</span>
                            <span class="px-2 py-0.5 rounded text-xs ${statusBadge}">${r.status}</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${date}</div>
                    </div>
                `;
            }).join('');
        });
}
let currentReportId = null;

function loadReportDetail(reportId) {
    currentReportId = reportId;
    fetch(`/portfolio/asset/${ASSET_ID}/reports/${reportId}`)
        .then(r => r.json())
        .then(data => {
            const panel = document.getElementById('reportDetail');
            const content = document.getElementById('reportDetailContent');
            const dateEl = document.getElementById('reportDetailDate');
            const btnEmail = document.getElementById('btnSendReportEmail');
            const btnAudio = document.getElementById('btnGenerateAudio');
            const audioStatus = document.getElementById('reportAudioStatus');
            const btnDownload = document.getElementById('btnDownloadAudio');
            if (!panel || !content) return;
            panel.classList.remove('hidden');
            dateEl.textContent = data.completed_at ? new Date(data.completed_at).toLocaleString('es-ES') : '';
            if (data.status === 'completed' && data.content) {
                content.innerHTML = typeof marked !== 'undefined' ? marked.parse(data.content) : data.content.replace(/\n/g, '<br>');
            } else if (data.status === 'failed') {
                content.innerHTML = '<p class="text-red-600">' + (data.error_msg || 'Error') + '</p>';
            } else {
                content.innerHTML = '<p class="text-gray-500">Cargando...</p>';
            }
            if (btnEmail) btnEmail.classList.add('hidden');
            if (btnAudio) btnAudio.classList.add('hidden');
            const btnRetry = document.getElementById('btnRetryAudio');
            if (btnRetry) btnRetry.classList.add('hidden');
            if (audioStatus) { audioStatus.classList.add('hidden'); audioStatus.textContent = ''; }
            if (btnDownload) btnDownload.classList.add('hidden');
            const audioPlayerWrap = document.getElementById('reportAudioPlayer');
            const audioEl = document.getElementById('audioPlayer');
            if (audioPlayerWrap) audioPlayerWrap.classList.add('hidden');
            if (audioEl) audioEl.src = '';
            if (data.status === 'completed') {
                if (btnEmail) btnEmail.classList.remove('hidden');
                if (btnAudio && data.audio_status !== 'completed' && data.audio_status !== 'failed') btnAudio.classList.remove('hidden');
                if (data.audio_status === 'processing') {
                    audioStatus.classList.remove('hidden');
                    audioStatus.className = 'px-3 py-1.5 rounded-lg text-sm bg-yellow-100 text-yellow-800';
                    audioStatus.textContent = 'Generando audio...';
                    pollAudioStatus(reportId);
                } else if (data.audio_status === 'completed') {
                    audioStatus.classList.remove('hidden');
                    audioStatus.className = 'px-3 py-1.5 rounded-lg text-sm bg-green-100 text-green-800';
                    audioStatus.textContent = 'Audio listo';
                    const audioBaseUrl = `/portfolio/asset/${ASSET_ID}/reports/${reportId}/audio`;
                    btnDownload.href = audioBaseUrl + '?download=1';
                    btnDownload.classList.remove('hidden');
                    const audioPlayerWrap = document.getElementById('reportAudioPlayer');
                    const audioEl = document.getElementById('audioPlayer');
                    if (audioPlayerWrap && audioEl) {
                        audioEl.src = audioBaseUrl;
                        audioPlayerWrap.classList.remove('hidden');
                    }
                } else if (data.audio_status === 'failed') {
                    audioStatus.classList.remove('hidden');
                    audioStatus.className = 'px-3 py-1.5 rounded-lg text-sm bg-red-100 text-red-800';
                    audioStatus.textContent = data.audio_error_msg || 'Error al generar audio';
                    if (btnRetry) btnRetry.classList.remove('hidden');
                }
            }
        });
}
function pollAudioStatus(reportId) {
    let pollCount = 0;
    const maxPolls = 450;
    const interval = setInterval(() => {
        pollCount++;
        if (pollCount > maxPolls) {
            clearInterval(interval);
            const audioStatus = document.getElementById('reportAudioStatus');
            const btnRetry = document.getElementById('btnRetryAudio');
            const btnAudio = document.getElementById('btnGenerateAudio');
            if (audioStatus) { audioStatus.className = 'px-3 py-1.5 rounded-lg text-sm bg-amber-100 text-amber-800'; audioStatus.textContent = 'La generaci√≥n tard√≥ demasiado.'; }
            if (btnRetry) btnRetry.classList.remove('hidden');
            return;
        }
        fetch(`/portfolio/api/reports/${reportId}/status`)
            .then(r => r.json())
            .then(data => {
                const audioStatus = document.getElementById('reportAudioStatus');
                const btnAudio = document.getElementById('btnGenerateAudio');
                const btnDownload = document.getElementById('btnDownloadAudio');
                if (data.audio_status === 'completed') {
                    clearInterval(interval);
                    const audioBaseUrl = `/portfolio/asset/${ASSET_ID}/reports/${reportId}/audio`;
                    if (audioStatus) { audioStatus.className = 'px-3 py-1.5 rounded-lg text-sm bg-green-100 text-green-800'; audioStatus.textContent = 'Audio listo'; }
                    if (btnDownload) { btnDownload.href = audioBaseUrl + '?download=1'; btnDownload.classList.remove('hidden'); }
                    if (btnAudio) btnAudio.classList.add('hidden');
                    const btnRetry = document.getElementById('btnRetryAudio');
                    if (btnRetry) { btnRetry.textContent = 'Regenerar audio'; btnRetry.classList.remove('hidden'); }
                    const audioPlayerWrap = document.getElementById('reportAudioPlayer');
                    const audioEl = document.getElementById('audioPlayer');
                    if (audioPlayerWrap && audioEl) { audioEl.src = audioBaseUrl; audioPlayerWrap.classList.remove('hidden'); }
                } else if (data.audio_status === 'failed') {
                    clearInterval(interval);
                    if (audioStatus) { audioStatus.className = 'px-3 py-1.5 rounded-lg text-sm bg-red-100 text-red-800'; audioStatus.textContent = data.audio_error_msg || 'Error'; }
                    const btnRetry = document.getElementById('btnRetryAudio');
                    if (btnRetry) btnRetry.classList.remove('hidden');
                }
            });
    }, 4000);
}
function sendReportEmail() {
    if (!currentReportId) return;
    const btn = document.getElementById('btnSendReportEmail');
    if (btn) btn.disabled = true;
    fetch(`/portfolio/asset/${ASSET_ID}/reports/${currentReportId}/send-email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) showToast(data.message || 'Informe enviado correctamente', 'success');
        else showToast(data.error || 'Error al enviar', 'error');
    })
    .catch(err => showToast('Error: ' + (err.message || err), 'error'))
    .finally(() => { if (btn) btn.disabled = false; });
}
function retryReportAudio() {
    if (!currentReportId) return;
    const btnRetry = document.getElementById('btnRetryAudio');
    const audioStatus = document.getElementById('reportAudioStatus');
    if (btnRetry) btnRetry.disabled = true;
    fetch(`/portfolio/asset/${ASSET_ID}/reports/${currentReportId}/reset-audio`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (audioStatus) { audioStatus.classList.add('hidden'); }
            if (btnRetry) btnRetry.classList.add('hidden');
            generateReportAudio();
        } else showToast(data.error || 'Error al resetear', 'error');
    })
    .catch(err => showToast('Error: ' + (err.message || err), 'error'))
    .finally(() => { if (btnRetry) btnRetry.disabled = false; });
}

function generateReportAudio() {
    if (!currentReportId) return;
    const btn = document.getElementById('btnGenerateAudio');
    const audioStatus = document.getElementById('reportAudioStatus');
    if (btn) btn.disabled = true;
    fetch(`/portfolio/asset/${ASSET_ID}/reports/${currentReportId}/generate-audio`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (data.audio_ready) {
                loadReportDetail(currentReportId);
            } else {
                if (audioStatus) { audioStatus.classList.remove('hidden'); audioStatus.className = 'px-3 py-1.5 rounded-lg text-sm bg-yellow-100 text-yellow-800'; audioStatus.textContent = 'Generando audio...'; }
                btn.classList.add('hidden');
                pollAudioStatus(currentReportId);
            }
        } else showToast(data.error || 'Error', 'error');
    })
    .catch(err => showToast('Error: ' + (err.message || err), 'error'))
    .finally(() => { if (btn) btn.disabled = false; });
}
function closeReportDetail() {
    const panel = document.getElementById('reportDetail');
    if (panel) panel.classList.add('hidden');
    currentReportId = null;
}
</script>
{% endblock %}

