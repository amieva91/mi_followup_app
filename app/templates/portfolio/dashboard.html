<!-- Template actualizada: 2025-10-12 - Sprint 4 HITO 1 Corregido -->
{% extends "base/layout.html" %}

{% block title %}Portfolio - FollowUp{% endblock %}

{% block content %}
<div class="max-w-[92%] mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">üìä Mi Portfolio</h1>
            <p class="text-gray-600 mt-1">Vista general de tus inversiones</p>
        </div>
        <div class="flex gap-3">
            <!-- Bot√≥n Actualizar Precios (Sprint 3 Final) -->
            <button onclick="startPriceUpdate()" class="btn-secondary flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Actualizar Precios
            </button>
            <!-- Bot√≥n Recalcular M√©tricas (Sprint 4 - Cache) -->
            <form method="POST" action="{{ url_for('portfolio.invalidate_cache') }}" class="inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn-secondary flex items-center gap-2" title="Recalcular todas las m√©tricas del portfolio">
                    ‚ôªÔ∏è Recalcular
                </button>
            </form>
            <a href="{{ url_for('portfolio.account_new') }}" class="btn-secondary">
                üè¶ Nueva Cuenta
            </a>
            <a href="{{ url_for('portfolio.transaction_new') }}" class="btn-primary">
                ‚ûï Nueva Transacci√≥n
            </a>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- M√âTRICAS GLOBALES E HIST√ìRICAS (PRIMERO)    -->
    <!-- ============================================ -->
    {% if metrics %}
    <div class="mb-2 flex justify-between items-center">
        <div>
            <h2 class="text-lg font-semibold text-gray-700">üåç M√©tricas Globales e Hist√≥ricas</h2>
            <p class="text-xs text-gray-500">Incluyen todo el hist√≥rico (posiciones actuales + cerradas + cash)</p>
        </div>
        {% if metrics.get('_from_cache') %}
        <div class="text-xs text-gray-500 bg-blue-50 px-3 py-1 rounded-full border border-blue-200">
            ‚ö° Cache (cargado en <200ms)
        </div>
        {% endif %}
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Valor Real Cuenta de Inversi√≥n -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-500" x-data="{ showDetails: false }">
            <div class="flex items-center justify-between mb-2">
                <div class="text-sm text-gray-600">üè¶ Valor Real Cuenta</div>
                <div class="flex items-center gap-2">
                    <button @click="showDetails = !showDetails" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                        <span x-show="!showDetails">‚ñº Ver desglose</span>
                        <span x-show="showDetails">‚ñ≤ Ocultar</span>
                    </button>
                    <span class="text-xs text-gray-400 cursor-help" title="Dinero real que tendr√≠a el usuario si liquidara todas las posiciones: Dep√≥sitos - Retiradas + P&L Realizado + P&L No Realizado + Dividendos - Comisiones">‚ìò</span>
                </div>
            </div>
            <div class="text-2xl font-bold text-indigo-600">
                {{ metrics.total_account.total_account_value|decimal_eu(2) }} EUR
            </div>
            
            <!-- Desglose detallado -->
            <div x-show="showDetails" x-cloak class="text-xs text-gray-500 mt-3 space-y-1 border-t pt-2">
                <div class="flex justify-between">
                    <span>‚Ä¢ Dep√≥sitos:</span>
                    <span>+{{ metrics.total_account.deposits|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ Retiradas:</span>
                    <span>-{{ metrics.total_account.withdrawals|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ P&L Realizado:</span>
                    <span>{% if metrics.total_account.pl_realized >= 0 %}+{% endif %}{{ metrics.total_account.pl_realized|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ P&L No Realizado:</span>
                    <span>{% if metrics.total_account.pl_unrealized >= 0 %}+{% endif %}{{ metrics.total_account.pl_unrealized|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ Dividendos:</span>
                    <span>+{{ metrics.total_account.dividends|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ Comisiones:</span>
                    <span>-{{ metrics.total_account.fees|decimal_eu(2) }}</span>
                </div>
                {% if metrics.total_account.cash > 0 %}
                <div class="flex justify-between">
                    <span>‚Ä¢ Cash disponible:</span>
                    <span>+{{ metrics.total_account.cash|decimal_eu(2) }}</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Indicador de Apalancamiento (solo si existe) -->
            {% if metrics.total_account.leverage > 0 %}
            <div class="text-xs mt-2 pt-2 border-t">
                <div class="flex justify-between items-center">
                    <span class="text-red-600">‚ö° Apalancamiento:</span>
                    <span class="font-medium text-red-600">
                        {{ metrics.total_account.leverage|decimal_eu(2) }} EUR
                    </span>
                </div>
                <div class="text-xs text-gray-400 mt-1">
                    (No incluido en Valor Total Cuenta)
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- P&L Total (UNIFICADO) -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if metrics.total_pl.total_pl >= 0 %}border-green-600{% else %}border-red-600{% endif %}" x-data="{ showDetails: false }">
            <div class="flex items-center justify-between mb-2">
                <div class="text-sm text-gray-600">üìä P&L Total</div>
                <div class="flex items-center gap-2">
                    <button @click="showDetails = !showDetails" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                        <span x-show="!showDetails">‚ñº Ver desglose</span>
                        <span x-show="showDetails">‚ñ≤ Ocultar</span>
                    </button>
                    <span class="text-xs text-gray-400 cursor-help" title="Ganancia/p√©rdida TOTAL hist√≥rica: P&L Realizado + P&L No Realizado + Dividendos - Comisiones">‚ìò</span>
                </div>
            </div>
            <div class="text-2xl font-bold {% if metrics.total_pl.total_pl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if metrics.total_pl.total_pl >= 0 %}+{% endif %}{{ metrics.total_pl.total_pl|decimal_eu(2) }} EUR
            </div>
            
            <!-- Desglose detallado -->
            <div x-show="showDetails" x-cloak class="text-xs text-gray-500 mt-3 space-y-1 border-t pt-2">
                <div class="flex justify-between">
                    <span>‚Ä¢ P&L Realizado:</span>
                    <span>{% if metrics.total_pl.pl_realized >= 0 %}+{% endif %}{{ metrics.total_pl.pl_realized|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ P&L No Realizado:</span>
                    <span>{% if metrics.total_pl.pl_unrealized >= 0 %}+{% endif %}{{ metrics.total_pl.pl_unrealized|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ Dividendos:</span>
                    <span>+{{ metrics.total_pl.dividends|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ Comisiones:</span>
                    <span>-{{ metrics.total_pl.fees|decimal_eu(2) }}</span>
                </div>
            </div>
            
            <div class="mt-3">
                <a href="{{ url_for('portfolio.pl_by_asset') }}" class="text-xs text-green-600 hover:text-green-800 font-medium">
                    Ver detalle por asset ‚Üí
                </a>
            </div>
        </div>
        
        <!-- ROI -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if metrics.roi.roi >= 0 %}border-blue-500{% else %}border-red-500{% endif %}" x-data="{ showDetails: false }">
            <div class="flex items-center justify-between mb-2">
                <div class="text-sm text-gray-600">üìà ROI</div>
                <div class="flex items-center gap-2">
                    <button @click="showDetails = !showDetails" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                        <span x-show="!showDetails">‚ñº Ver desglose</span>
                        <span x-show="showDetails">‚ñ≤ Ocultar</span>
                    </button>
                    <span class="text-xs text-gray-400 cursor-help" title="Return on Investment: rentabilidad total sobre el capital aportado. F√≥rmula: (Valor Actual + Retiradas - Dep√≥sitos) / Dep√≥sitos √ó 100">‚ìò</span>
                </div>
            </div>
            <div class="text-2xl font-bold {% if metrics.roi.roi >= 0 %}text-blue-600{% else %}text-red-600{% endif %}">
                {% if metrics.roi.roi >= 0 %}+{% endif %}{{ metrics.roi.roi|decimal_eu(2) }}%
            </div>
            
            <!-- Desglose detallado -->
            <div x-show="showDetails" x-cloak class="text-xs text-gray-500 mt-3 space-y-1 border-t pt-2">
                <div class="flex justify-between">
                    <span>‚Ä¢ Valor Actual:</span>
                    <span>{{ total_value|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ Retiradas:</span>
                    <span>+{{ metrics.roi.total_withdrawals|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between">
                    <span>‚Ä¢ Dep√≥sitos:</span>
                    <span>-{{ metrics.roi.total_deposits|decimal_eu(2) }}</span>
                </div>
                <div class="flex justify-between font-medium">
                    <span>= Retorno absoluto:</span>
                    <span>{% if metrics.roi.absolute_return >= 0 %}+{% endif %}{{ metrics.roi.absolute_return|decimal_eu(2) }}</span>
                </div>
            </div>
        </div>
        
        <!-- Modified Dietz (Rentabilidad) -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if metrics.modified_dietz.total.return_pct >= 0 %}border-purple-500{% else %}border-red-500{% endif %}" x-data="{ showDetails: false }">
            <div class="flex items-center justify-between mb-2">
                <div class="text-sm text-gray-600">üíé Rentabilidad (Modified Dietz)</div>
                <div class="flex items-center gap-2">
                    <button @click="showDetails = !showDetails" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                        <span x-show="!showDetails">‚ñº Ver desglose</span>
                        <span x-show="showDetails">‚ñ≤ Ocultar</span>
                    </button>
                    <span class="text-xs text-gray-400 cursor-help" title="Rentabilidad usando Modified Dietz Method (est√°ndar GIPS). Elimina el efecto de los flujos de caja (deposits/withdrawals) para medir la performance real de tu estrategia.">‚ìò</span>
                </div>
            </div>
            <div class="text-2xl font-bold {% if metrics.modified_dietz.annualized.return_pct >= 0 %}text-purple-600{% else %}text-red-600{% endif %}">
                {% if metrics.modified_dietz.annualized.return_pct >= 0 %}+{% endif %}{{ metrics.modified_dietz.annualized.return_pct|decimal_eu(2) }}%
            </div>
            <div class="text-xs text-gray-500">Anualizada ({{ metrics.modified_dietz.annualized.years }} a√±os)</div>
            
            <!-- M√©tricas adicionales -->
            <div x-show="showDetails" x-cloak class="text-xs text-gray-500 mt-3 space-y-1 border-t pt-2">
                <div class="flex justify-between">
                    <span>üìÖ A√±o Actual (YTD):</span>
                    <span class="font-medium {% if metrics.modified_dietz.ytd.return_pct >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if metrics.modified_dietz.ytd.return_pct >= 0 %}+{% endif %}{{ metrics.modified_dietz.ytd.return_pct|decimal_eu(2) }}%
                    </span>
                </div>
                <div class="flex justify-between">
                    <span>üìä Rentabilidad Total:</span>
                    <span class="font-medium {% if metrics.modified_dietz.total.return_pct >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if metrics.modified_dietz.total.return_pct >= 0 %}+{% endif %}{{ metrics.modified_dietz.total.return_pct|decimal_eu(2) }}%
                    </span>
                </div>
                <div class="flex justify-between border-t pt-1 mt-1">
                    <span>üí∞ Ganancia absoluta:</span>
                    <span class="font-medium {% if metrics.modified_dietz.total.absolute_gain >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if metrics.modified_dietz.total.absolute_gain >= 0 %}+{% endif %}{{ metrics.modified_dietz.total.absolute_gain|decimal_eu(2) }} EUR
                    </span>
                </div>
            </div>
            
            <!-- Informaci√≥n adicional -->
            <div class="text-xs text-gray-400 mt-3 pt-2 border-t">
                <div>üìÜ {{ metrics.modified_dietz.total.days }} d√≠as de inversi√≥n</div>
            </div>
        </div>
        
    </div>
    
    <!-- Comparaci√≥n con Benchmarks (si hay datos) - OCUPA TODO EL ANCHO -->
    {% if benchmark_annualized and benchmark_annualized.portfolio_annualized is not none %}
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500 mb-8">
        <div class="flex items-center justify-between mb-3">
            <div class="text-sm text-gray-600">üèÜ Comparaci√≥n con √çndices</div>
            <span class="text-xs text-gray-400 cursor-help" title="Comparaci√≥n de tu rentabilidad anualizada con los principales √≠ndices de referencia desde tu fecha de inicio ({{ benchmark_annualized.start_date }})">‚ìò</span>
        </div>
        <div class="text-2xl font-bold {% if benchmark_annualized.portfolio_annualized >= 0 %}text-orange-600{% else %}text-red-600{% endif %} mb-1">
            {% if benchmark_annualized.portfolio_annualized >= 0 %}+{% endif %}{{ benchmark_annualized.portfolio_annualized|decimal_eu(2) }}%
        </div>
        <div class="text-xs text-gray-500 mb-4">Tu rentabilidad anualizada</div>
        
        <!-- Comparaci√≥n detallada con benchmarks - Layout horizontal ocupando todo el ancho -->
        {% if benchmark_annualized.benchmarks %}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 border-t pt-4">
            {% for benchmark_name in ['S&P 500', 'NASDAQ 100', 'MSCI World', 'EuroStoxx 50'] %}
                {% if benchmark_name in benchmark_annualized.benchmarks %}
                    {% set bench_return = benchmark_annualized.benchmarks[benchmark_name] %}
                    {% set diff = benchmark_annualized.differences[benchmark_name] %}
                    {% if benchmark_annualized.benchmarks_annualized and benchmark_name in benchmark_annualized.benchmarks_annualized %}
                        {% set bench_annualized_value = benchmark_annualized.benchmarks_annualized[benchmark_name] %}
                    {% else %}
                        {% set bench_annualized_value = None %}
                    {% endif %}
                    {% if benchmark_annualized.differences_annualized and benchmark_name in benchmark_annualized.differences_annualized %}
                        {% set diff_annualized = benchmark_annualized.differences_annualized[benchmark_name] %}
                    {% else %}
                        {% set diff_annualized = None %}
                    {% endif %}
                    <div class="p-4 rounded-lg {% if diff >= 0 %}bg-green-50 border border-green-200{% else %}bg-red-50 border border-red-200{% endif %}">
                        <div class="font-medium text-gray-800 text-sm mb-2">{{ benchmark_name }}</div>
                        {% if bench_annualized_value is not none %}
                        <div class="text-xs text-gray-700 mb-1 font-medium">
                            {% if bench_annualized_value >= 0 %}+{% endif %}{{ bench_annualized_value|decimal_eu(2) }}% anualizado
                        </div>
                        <div class="text-xs text-gray-500 mb-3">
                            ({% if bench_return >= 0 %}+{% endif %}{{ bench_return|decimal_eu(2) }}% total)
                        </div>
                        {% else %}
                        <div class="text-xs text-gray-600 mb-3">
                            {% if bench_return >= 0 %}+{% endif %}{{ bench_return|decimal_eu(2) }}% total
                        </div>
                        {% endif %}
                        <div class="text-right">
                            {% if diff_annualized is not none %}
                            <div class="font-bold text-lg {% if diff_annualized >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                                {% if diff_annualized >= 0 %}+{% endif %}{{ diff_annualized|decimal_eu(2) }}%
                            </div>
                            <div class="text-xs text-gray-500">diferencia (anualizado)</div>
                            {% else %}
                            <div class="font-bold text-lg {% if diff >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                                {% if diff >= 0 %}+{% endif %}{{ diff|decimal_eu(2) }}%
                            </div>
                            <div class="text-xs text-gray-500">diferencia</div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        <div class="text-xs text-gray-400 mt-4 pt-3 border-t">
            <a href="{{ url_for('portfolio.performance') }}" class="text-blue-600 hover:text-blue-800 font-medium">
                Ver gr√°fico comparativo completo ‚Üí
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- ============================================ -->
    <!-- RENTABILIDADES A√ëO A A√ëO                     -->
    <!-- ============================================ -->
    {% if yearly_returns and yearly_returns|length > 0 %}
    <div class="mb-2 mt-8">
        <h2 class="text-lg font-semibold text-gray-700">üìÖ Rentabilidades A√±o a A√±o</h2>
        <p class="text-xs text-gray-500">Rentabilidad anual calculada con Modified Dietz (el √∫ltimo a√±o es YTD)</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-200">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Lista de rentabilidades -->
            <div x-data="{ showAll: false }">
                <h3 class="text-md font-semibold text-gray-800 mb-4">üìä Resumen por A√±o</h3>
                <div class="space-y-3">
                    {% set recent_years = yearly_returns[:5] %}
                    {% set older_years = yearly_returns[5:] %}
                    
                    {% for yr in recent_years %}
                    <div class="flex items-center justify-between p-3 rounded-lg {% if yr.return_pct >= 0 %}bg-green-50 border border-green-200{% else %}bg-red-50 border border-red-200{% endif %}">
                        <div class="flex items-center gap-3">
                            <div class="text-lg font-bold {% if yr.return_pct >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                                {{ yr.year }}{% if yr.is_ytd %} <span class="text-xs font-normal">(YTD)</span>{% endif %}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold {% if yr.return_pct >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                                {% if yr.return_pct >= 0 %}+{% endif %}{{ yr.return_pct|decimal_eu(2) }}%
                            </div>
                            <div class="text-xs text-gray-600">
                                {% if yr.absolute_gain >= 0 %}+{% endif %}{{ yr.absolute_gain|decimal_eu(2) }} EUR
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if older_years|length > 0 %}
                    <div x-show="showAll" x-collapse class="space-y-3">
                        {% for yr in older_years %}
                        <div class="flex items-center justify-between p-3 rounded-lg {% if yr.return_pct >= 0 %}bg-green-50 border border-green-200{% else %}bg-red-50 border border-red-200{% endif %}">
                            <div class="flex items-center gap-3">
                                <div class="text-lg font-bold {% if yr.return_pct >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                                    {{ yr.year }}{% if yr.is_ytd %} <span class="text-xs font-normal">(YTD)</span>{% endif %}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold {% if yr.return_pct >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                                    {% if yr.return_pct >= 0 %}+{% endif %}{{ yr.return_pct|decimal_eu(2) }}%
                                </div>
                                <div class="text-xs text-gray-600">
                                    {% if yr.absolute_gain >= 0 %}+{% endif %}{{ yr.absolute_gain|decimal_eu(2) }} EUR
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button @click="showAll = !showAll" class="w-full mt-3 p-2 text-sm font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-lg border border-blue-200 transition-colors">
                        <span x-show="!showAll">‚ñº Ver {{ older_years|length }} a√±o{{ 's' if older_years|length != 1 else '' }} anterior{{ 'es' if older_years|length != 1 else '' }}</span>
                        <span x-show="showAll">‚ñ≤ Ocultar a√±os anteriores</span>
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <!-- Gr√°fico de barras -->
            <div>
                <h3 class="text-md font-semibold text-gray-800 mb-4">üìà Gr√°fico de Rentabilidades</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="yearlyReturnsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- ============================================ -->
    <!-- DIVIDENDOS                                   -->
    <!-- ============================================ -->
    {% if monthly_dividends or annualized_dividends %}
    <div class="mb-2 mt-8">
        <h2 class="text-lg font-semibold text-gray-700">üí∞ Dividendos</h2>
        <p class="text-xs text-gray-500">√öltimos 12 meses (mes a mes) y proyecci√≥n anualizada desde el inicio</p>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-200">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- √öltimos 12 meses -->
            {% if monthly_dividends and monthly_dividends|length > 0 %}
            <div>
                <h3 class="text-md font-semibold text-gray-800 mb-4">üìÖ √öltimos 12 Meses</h3>
                <div class="relative" style="height: 300px;">
                    <canvas id="monthlyDividendsChart"></canvas>
                </div>
                <div class="mt-4 text-xs text-gray-600">
                    <div class="flex justify-between items-center mb-1">
                        <span>Total √∫ltimos 12 meses:</span>
                        <span class="font-semibold">{{ monthly_dividends | sum(attribute='dividends_eur') | decimal_eu(2) }} EUR</span>
                    </div>
                </div>
                
                <!-- Gr√°fico a√±o a a√±o desde el inicio -->
                {% if yearly_dividends and yearly_dividends|length > 0 %}
                <div class="mt-8">
                    <h3 class="text-md font-semibold text-gray-800 mb-4">üìä A√±o a A√±o (Desde el Inicio)</h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="yearlyDividendsChart"></canvas>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- M√©tricas anualizadas -->
            {% if annualized_dividends %}
            <div>
                <h3 class="text-md font-semibold text-gray-800 mb-4">üìä M√©tricas Anualizadas</h3>
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="text-sm text-gray-600 mb-1">YTD (A√±o Actual)</div>
                        <div class="text-2xl font-bold text-blue-700">
                            {{ annualized_dividends.total_dividends_ytd|decimal_eu(2) }} EUR
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            {{ annualized_dividends.ytd_days }} d√≠as transcurridos
                        </div>
                    </div>
                    
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <div class="text-sm text-gray-600 mb-1">Total Hist√≥rico</div>
                        <div class="text-2xl font-bold text-purple-700">
                            {{ annualized_dividends.total_dividends_all_time|decimal_eu(2) }} EUR
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Desde {{ annualized_dividends.first_transaction_date.strftime('%d/%m/%Y') if annualized_dividends.first_transaction_date else 'N/A' }}
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="text-sm text-gray-600 mb-1">Promedio Anual Hist√≥rico</div>
                        <div class="text-2xl font-bold text-gray-700">
                            {{ annualized_dividends.average_annual_dividends|decimal_eu(2) }} EUR
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            {{ annualized_dividends.years_investing|decimal_eu(1) }} a√±os de inversi√≥n
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- ============================================ -->
    <!-- M√âTRICAS DEL PORTFOLIO ACTUAL (SEGUNDO)     -->
    <!-- ============================================ -->
    <div class="mb-2">
        <h2 class="text-lg font-semibold text-gray-700">üìä M√©tricas del Portfolio Actual</h2>
        <p class="text-xs text-gray-500">Basadas solo en las posiciones abiertas actuales</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
        <!-- Valor Total Cartera (CON COSTE TOTAL DENTRO) -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500" x-data="{ showDetails: false }">
            <div class="flex items-center justify-between mb-1">
                <div class="text-sm text-gray-600">üí∞ Valor Total Cartera</div>
                <div class="flex items-center gap-2">
                    <button @click="showDetails = !showDetails" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                        <span x-show="!showDetails">‚ñº Ver desglose</span>
                        <span x-show="showDetails">‚ñ≤ Ocultar</span>
                    </button>
                    <span class="text-xs text-gray-400 cursor-help" title="Valor actual de todas las posiciones abiertas. Se calcula sumando (cantidad √ó precio actual) para cada activo.">‚ìò</span>
                </div>
            </div>
            <div class="text-2xl font-bold text-gray-900">
                {{ total_value|decimal_eu(2) }} EUR
            </div>
            
            <!-- Desglose detallado -->
            <div x-show="showDetails" x-cloak class="text-xs text-gray-500 mt-3 space-y-1 border-t pt-2">
                <div class="flex justify-between">
                    <span>üìä Posiciones abiertas:</span>
                    <span class="font-medium">{{ holdings|length if holdings else 0 }}</span>
                </div>
                <div class="flex justify-between">
                    <span>üè∑Ô∏è Coste Total:</span>
                    <span class="font-medium">{{ total_cost|decimal_eu(2) }} EUR</span>
                </div>
            </div>
        </div>
        
        <!-- P&L No Realizado -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if total_pl >= 0 %}border-green-600{% else %}border-red-600{% endif %}">
            <div class="flex items-center justify-between mb-1">
                <div class="text-sm text-gray-600">üìà P&L No Realizado</div>
                <span class="text-xs text-gray-400 cursor-help" title="Ganancia/p√©rdida de posiciones abiertas: Valor Actual - Coste Total. No incluye posiciones cerradas.">‚ìò</span>
            </div>
            <div class="text-2xl font-bold {% if total_pl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if total_pl >= 0 %}+{% endif %}{{ total_pl|decimal_eu(2) }} EUR
            </div>
        </div>
        
        <!-- Retorno % -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if total_pl_pct >= 0 %}border-green-600{% else %}border-red-600{% endif %}">
            <div class="flex items-center justify-between mb-1">
                <div class="text-sm text-gray-600">üìä Retorno</div>
                <span class="text-xs text-gray-400 cursor-help" title="Porcentaje de retorno sobre el coste de las posiciones actuales: (P&L No Realizado / Coste Total) √ó 100">‚ìò</span>
            </div>
            <div class="text-2xl font-bold {% if total_pl_pct >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if total_pl_pct >= 0 %}+{% endif %}{{ total_pl_pct|decimal_eu(2) }}%
            </div>
        </div>
        
        <!-- Leverage / Dinero Prestado o Cash -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if metrics.leverage.broker_money > 0 %}border-red-500{% else %}border-cyan-500{% endif %}" x-data="{ showDetails: false }">
            <div class="flex items-center justify-between mb-2">
                <div class="text-sm text-gray-600">
                    {% if metrics.leverage.broker_money > 0 %}
                    ‚ö° Dinero Prestado
                    {% else %}
                    üíµ Cash en Cuenta
                    {% endif %}
                </div>
                <div class="flex items-center gap-2">
                    <button @click="showDetails = !showDetails" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                        <span x-show="!showDetails">‚ñº Ver desglose</span>
                        <span x-show="showDetails">‚ñ≤ Ocultar</span>
                    </button>
                    <span class="text-xs text-gray-400 cursor-help" title="Apalancamiento = Coste Total - Dinero del Usuario. Dinero Usuario = Dep√≥sitos - Retiradas + P&L Realizado + Dividendos - Comisiones. Positivo = apalancamiento (broker presta dinero). Negativo = cash disponible sin invertir.">‚ìò</span>
                </div>
            </div>
            <div class="text-2xl font-bold {% if metrics.leverage.broker_money > 0 %}text-red-600{% else %}text-cyan-600{% endif %}">
                {% if metrics.leverage.broker_money >= 0 %}+{% endif %}{{ metrics.leverage.broker_money|decimal_eu(2) }} EUR
            </div>
            
            <!-- Desglose detallado -->
            <div x-show="showDetails" x-cloak class="text-xs text-gray-500 mt-3 space-y-1 border-t pt-2">
                <div class="flex justify-between mb-1">
                    <span>üíº Coste Total:</span>
                    <span class="font-medium">{{ total_cost|decimal_eu(2) }} EUR</span>
                </div>
                <div class="flex justify-between">
                    <span>üí∞ Dinero usuario:</span>
                    <span class="font-medium">{{ metrics.total_account.total_account_value|decimal_eu(2) }} EUR</span>
                </div>
                <div class="text-xs text-gray-500 italic mb-1 mt-1">
                    <span>F√≥rmula: Dep√≥sitos - Retiradas + P&L Realizado + P&L No Realizado + Dividendos - Comisiones</span>
                </div>
                <div class="text-xs text-gray-400 ml-3 space-y-0.5">
                    <div class="flex justify-between">
                        <span>‚Ä¢ Dep√≥sitos:</span>
                        <span>+{{ metrics.total_account.deposits|decimal_eu(2) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚Ä¢ Retiradas:</span>
                        <span>-{{ metrics.total_account.withdrawals|decimal_eu(2) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚Ä¢ P&L Realizado:</span>
                        <span>{% if metrics.total_account.pl_realized >= 0 %}+{% endif %}{{ metrics.total_account.pl_realized|decimal_eu(2) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚Ä¢ P&L No Realizado:</span>
                        <span>{% if metrics.total_account.pl_unrealized >= 0 %}+{% endif %}{{ metrics.total_account.pl_unrealized|decimal_eu(2) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚Ä¢ Dividendos:</span>
                        <span>+{{ metrics.total_account.dividends|decimal_eu(2) }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚Ä¢ Comisiones:</span>
                        <span>-{{ metrics.total_account.fees|decimal_eu(2) }}</span>
                    </div>
                </div>
            </div>
            
            {% if metrics.leverage.broker_money > 0 %}
            <div class="text-xs text-red-600 mt-2 font-medium">
                Ratio: {{ metrics.leverage.leverage_ratio|decimal_eu(2) }}% apalancamiento
            </div>
            {% endif %}
        </div>
        
    </div>
    
    <!-- Gr√°ficos de Distribuci√≥n: Pa√≠ses y Sectores (Fila 1) -->
    {% if country_distribution or sector_distribution or asset_distribution or industry_distribution or broker_distribution or asset_type_distribution %}
    <div class="mb-2 mt-8">
        <h2 class="text-lg font-semibold text-gray-700">üìä Distribuci√≥n del Portfolio</h2>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Gr√°fico de Pa√≠ses -->
        {% if country_distribution %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üåç Distribuci√≥n por Pa√≠s</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="countryChart"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Gr√°fico de Sectores -->
        {% if sector_distribution %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üè≠ Distribuci√≥n por Sector</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="sectorChart"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Gr√°fico de Assets (Top 10) -->
        {% if asset_distribution %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üìà Distribuci√≥n por Asset (Top 10)</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="assetChart"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Gr√°fico de Industrias -->
        {% if industry_distribution %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üè∑Ô∏è Distribuci√≥n por Industria</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="industryChart"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Gr√°fico de Brokers -->
        {% if broker_distribution %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üè¶ Distribuci√≥n por Broker</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="brokerChart"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Gr√°fico de Tipos -->
        {% if asset_type_distribution %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">üì¶ Distribuci√≥n por Tipo</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="assetTypeChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    {% endif %}
    
    <!-- √öltima actualizaci√≥n e informaci√≥n -->
    <div class="flex justify-between items-center text-xs text-gray-500 mb-8">
        {% if last_sync %}
        <div>
            üì• √öltima sincronizaci√≥n: {{ last_sync.created_at.strftime('%d/%m/%Y %H:%M') }}
        </div>
        {% else %}
        <div></div>
        {% endif %}
        
        {% if last_price_update %}
        <div>
            üì° √öltima actualizaci√≥n de precios: {{ last_price_update.strftime('%d/%m/%Y %H:%M') }}
        </div>
        {% endif %}
    </div>

    <!-- RESTO DEL CONTENIDO: Holdings, Modal, etc. -->
    <!-- (Mantenemos el resto igual, solo copio la parte de holdings) -->
    
    <!-- Holdings actuales -->
    {% if holdings %}
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900">üíº Posiciones Actuales <span class="text-lg font-normal text-gray-600">({{ holdings|length }})</span></h2>
            <a href="{{ url_for('portfolio.holdings_list') }}" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                Ver todas ‚Üí
            </a>
        </div>
        
        <!-- Tabla de holdings (versi√≥n dashboard) -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th onclick="sortTableHoldings(0, 'text')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Activo <span class="sort-arrow">‚áÖ</span>
                        </th>
                        <th onclick="sortTableHoldings(1, 'text')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Cuenta <span class="sort-arrow">‚áÖ</span>
                        </th>
                        <th onclick="sortTableHoldings(2, 'number')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Cantidad <span class="sort-arrow">‚áÖ</span>
                        </th>
                        <th onclick="sortTableHoldings(3, 'number')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Precio Medio Compra <span class="sort-arrow">‚áÖ</span>
                        </th>
                        <th onclick="sortTableHoldings(4, 'number')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Precio Actual <span class="sort-arrow">‚áÖ</span>
                        </th>
                        <th onclick="sortTableHoldings(5, 'number')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Valor Actual <span class="sort-arrow">‚áÖ</span>
                        </th>
                        <th onclick="sortTableHoldings(6, 'number')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            P&L <span class="sort-arrow">‚áÖ</span>
                        </th>
                        <th onclick="sortTableHoldings(7, 'number')" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Peso % <span class="sort-arrow">‚áÖ</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for holding in holdings %}
                    <tr class="hover:bg-gray-50">
                        <!-- Activo -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-bold text-gray-900">
                                        <a href="{{ url_for('portfolio.asset_detail', id=holding['asset'].id) }}" class="hover:text-blue-600">
                                            {{ holding['asset'].name if holding['asset'].name else holding['asset'].symbol }}
                                        </a>
                                    </div>
                                    <div class="text-xs text-gray-400">
                                        {% if holding['asset'].asset_type %}{{ holding['asset'].asset_type }}{% endif %}
                                        {% if holding['asset'].symbol %} ‚Ä¢ {{ holding['asset'].symbol }}{% endif %}
                                        {% if holding['asset'].exchange %} ‚Ä¢ {{ holding['asset'].exchange }}{% endif %}
                                        {% if holding['asset'].currency %} ‚Ä¢ {{ holding['asset'].currency }}{% endif %}
                                        {% if holding['asset'].isin %} ‚Ä¢ {{ holding['asset'].isin }}{% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Cuenta -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {% if holding['brokers']|length == 1 %}
                                    {{ holding['brokers'][0] }}
                                {% else %}
                                    {{ holding['brokers']|length }} cuentas
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Cantidad -->
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">
                            {{ holding['total_quantity']|decimal_eu(0) }}
                        </td>
                        
                        <!-- Precio Medio Compra -->
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% if holding['average_buy_price'] and holding['average_buy_price'] > 0 %}
                            <div class="text-sm text-gray-900">{{ holding['average_buy_price']|decimal_eu(2) }} {{ holding['asset'].currency }}</div>
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- Precio Actual -->
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% if holding['asset'].current_price %}
                            <div class="text-sm text-gray-900">{{ holding['asset'].current_price|decimal_eu(2) }} {{ holding['asset'].currency }}</div>
                            {% else %}
                            <span class="text-xs text-gray-400">Sin precio</span>
                            {% endif %}
                        </td>
                        
                        <!-- Valor Actual (EUR + local currency) -->
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% if 'current_value_eur' in holding %}
                            <div class="text-sm font-medium text-gray-900">
                                {{ holding['current_value_eur']|decimal_eu(2) }} EUR
                            </div>
                            {% if 'local_currency' in holding and holding['local_currency'] != 'EUR' %}
                            <div class="text-xs text-gray-500">
                                ({{ holding['current_value_local']|decimal_eu(2) }} {{ holding['local_currency'] }})
                            </div>
                            {% endif %}
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- P&L -->
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            {% if 'pl_eur' in holding and holding['pl_eur'] != 0 %}
                            <span class="text-sm font-medium {% if holding['pl_eur'] >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                {% if holding['pl_eur'] >= 0 %}+{% endif %}{{ holding['pl_eur']|decimal_eu(2) }} EUR
                            </span>
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                        </td>
                        
                        <!-- Peso % -->
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-500">
                            {{ holding['weight_pct']|decimal_eu(2) }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="bg-white rounded-xl shadow-sm p-12 text-center">
        <div class="text-4xl mb-4">üìä</div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No hay posiciones todav√≠a</h3>
        <p class="text-gray-600 mb-6">Comienza a√±adiendo transacciones o importando un CSV</p>
        <div class="flex gap-3 justify-center">
            <a href="{{ url_for('portfolio.transaction_new') }}" class="btn-primary">
                ‚ûï Nueva Transacci√≥n
            </a>
            <a href="{{ url_for('portfolio.import_csv') }}" class="btn-secondary">
                üìÅ Importar CSV
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de actualizaci√≥n de precios (Sprint 3 Final) -->
<div id="priceUpdateModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-lg font-medium text-gray-900">
                    üîÑ Actualizando precios...
                </h3>
                <div id="spinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            </div>
            
            <!-- Barra de progreso -->
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span id="progressText">0 / 0</span>
                    <span id="estimatedTime"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Resultados -->
            <div id="results" class="hidden mb-4">
                <div class="text-sm text-gray-600 space-y-1">
                    <div class="flex justify-between">
                        <span>‚úÖ Actualizados:</span>
                        <span id="successCount" class="font-medium text-green-600">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚ùå Fallidos:</span>
                        <span id="failedCount" class="font-medium text-red-600">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>‚ö†Ô∏è Omitidos:</span>
                        <span id="skippedCount" class="font-medium text-orange-600">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Mensaje de error -->
            <div id="errorMessage" class="hidden text-sm text-red-600 mb-4"></div>
            
            <!-- Bot√≥n cerrar -->
            <div class="flex justify-end">
                <button id="closeModalBtn" onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== ORDENACI√ìN DE TABLA ====================
// Ordenar tabla de holdings (con soporte para formato europeo)
let sortDirectionHoldings = {};

function sortTableHoldings(columnIndex, type) {
    const table = document.querySelector('.min-w-full');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Alternar direcci√≥n
    if (!sortDirectionHoldings[columnIndex]) {
        sortDirectionHoldings[columnIndex] = 'asc';
    } else {
        sortDirectionHoldings[columnIndex] = sortDirectionHoldings[columnIndex] === 'asc' ? 'desc' : 'asc';
    }
    
    const direction = sortDirectionHoldings[columnIndex];
    
    // Ordenar filas
    rows.sort((a, b) => {
        const cellA = a.querySelectorAll('td')[columnIndex];
        const cellB = b.querySelectorAll('td')[columnIndex];
        
        let valueA, valueB;
        
        if (type === 'number') {
            // Extraer n√∫mero con formato europeo (1.234,56)
            let textA = cellA.textContent.trim().replace(/[^\d.,-]/g, '');
            let textB = cellB.textContent.trim().replace(/[^\d.,-]/g, '');
            
            // Convertir formato europeo a est√°ndar (eliminar puntos de miles, coma a punto)
            textA = textA.replace(/\./g, '').replace(',', '.');
            textB = textB.replace(/\./g, '').replace(',', '.');
            
            valueA = parseFloat(textA) || 0;
            valueB = parseFloat(textB) || 0;
        } else {
            // Texto
            valueA = cellA.textContent.trim().toLowerCase();
            valueB = cellB.textContent.trim().toLowerCase();
        }
        
        if (direction === 'asc') {
            return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
            return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
    });
    
    // Reordenar filas en el DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Actualizar flechas
    document.querySelectorAll('.sort-arrow').forEach(arrow => arrow.textContent = '‚áÖ');
    const currentArrow = table.querySelectorAll('th')[columnIndex].querySelector('.sort-arrow');
    currentArrow.textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
}

// Funciones del modal de actualizaci√≥n de precios
function startPriceUpdate() {
    const modal = document.getElementById('priceUpdateModal');
    const modalTitle = document.getElementById('modalTitle');
    const spinner = document.getElementById('spinner');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const estimatedTime = document.getElementById('estimatedTime');
    const results = document.getElementById('results');
    const errorMessage = document.getElementById('errorMessage');
    
    // Reset UI
    modal.classList.remove('hidden');
    modalTitle.textContent = 'üîÑ Actualizando precios...';
    spinner.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = '0 / 0';
    estimatedTime.textContent = '';
    results.classList.add('hidden');
    errorMessage.classList.add('hidden');
    
    // Fetch inicial para empezar la actualizaci√≥n
    // Obtener CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                      document.querySelector('input[name="csrf_token"]')?.value;
    
    const formData = new FormData();
    if (csrfToken) {
        formData.append('csrf_token', csrfToken);
    }
    
    fetch('/portfolio/prices/update', { 
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started') {
                pollProgress();
            } else {
                showError('Error al iniciar actualizaci√≥n');
            }
        })
        .catch(error => {
            showError('Error de red: ' + error.message);
        });
}

function pollProgress() {
    fetch('/portfolio/prices/update/progress')
        .then(response => response.json())
        .then(data => {
            updateProgressUI(data);
            
            if (data.status === 'completed' || data.status === 'failed') {
                onUpdateComplete(data);
            } else {
                setTimeout(pollProgress, 500);
            }
        })
        .catch(error => {
            console.error('Error polling:', error);
            setTimeout(pollProgress, 1000);
        });
}

function updateProgressUI(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const estimatedTime = document.getElementById('estimatedTime');
    
    if (data.total > 0) {
        const percentage = (data.current / data.total) * 100;
        progressBar.style.width = percentage + '%';
        progressText.textContent = `${data.current} / ${data.total}`;
        
        if (data.estimated_seconds && data.estimated_seconds > 0) {
            estimatedTime.textContent = `~${data.estimated_seconds}s restantes`;
        }
    }
}

function onUpdateComplete(data) {
    console.log('onUpdateComplete called with data:', data);
    const modalTitle = document.getElementById('modalTitle');
    const spinner = document.getElementById('spinner');
    const results = document.getElementById('results');
    const successCount = document.getElementById('successCount');
    const failedCount = document.getElementById('failedCount');
    const skippedCount = document.getElementById('skippedCount');
    const errorMessage = document.getElementById('errorMessage');
    
    console.log('Elements found:', {
        modalTitle: !!modalTitle,
        spinner: !!spinner,
        results: !!results,
        successCount: !!successCount,
        failedCount: !!failedCount,
        skippedCount: !!skippedCount,
        errorMessage: !!errorMessage
    });
    
    spinner.classList.add('hidden');
    
    if (data.status === 'completed') {
        modalTitle.textContent = '‚úÖ Actualizaci√≥n completada';
        results.classList.remove('hidden');
        // Usar los valores aplanados del backend o los del result si existen
        const result = data.result || {};
        const success = data.success !== undefined ? data.success : (result.success || 0);
        const failed = data.failed !== undefined ? data.failed : (result.failed || 0);
        const skipped = data.skipped !== undefined ? data.skipped : (result.skipped || 0);
        
        console.log('Setting values:', { success, failed, skipped });
        
        if (successCount) successCount.textContent = success;
        if (failedCount) failedCount.textContent = failed;
        if (skippedCount) {
            skippedCount.textContent = skipped;
            console.log('skippedCount element found and value set to:', skipped);
        } else {
            console.error('skippedCount element NOT FOUND!');
        }
    } else {
        modalTitle.textContent = '‚ùå Error en actualizaci√≥n';
        errorMessage.textContent = data.message || 'Error desconocido';
        errorMessage.classList.remove('hidden');
    }
}

function showError(message) {
    const modalTitle = document.getElementById('modalTitle');
    const spinner = document.getElementById('spinner');
    const errorMessage = document.getElementById('errorMessage');
    
    modalTitle.textContent = '‚ùå Error';
    spinner.classList.add('hidden');
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
}

function closeModal() {
    const modal = document.getElementById('priceUpdateModal');
    modal.classList.add('hidden');
    // Recargar la p√°gina para mostrar los precios actualizados
    window.location.reload();
}
</script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Gr√°ficos de Distribuci√≥n: Pa√≠ses y Sectores -->
{% if country_distribution or sector_distribution %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Colores para los gr√°ficos
    const colors = [
        '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
        '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1',
        '#14B8A6', '#A855F7', '#F43F5E', '#0EA5E9', '#22C55E'
    ];
    
    {% if country_distribution %}
    // Gr√°fico de Pa√≠ses
    const countryCtx = document.getElementById('countryChart');
    if (countryCtx) {
        const countryData = {
            labels: [{% for country, value in country_distribution %}'{{ country }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for country, value in country_distribution %}{{ value }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: colors.slice(0, {{ country_distribution|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        
        new Chart(countryCtx, {
            type: 'pie',
            data: countryData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString('es-ES', {style: 'currency', currency: 'EUR', maximumFractionDigits: 0}) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if sector_distribution %}
    // Gr√°fico de Sectores
    const sectorCtx = document.getElementById('sectorChart');
    if (sectorCtx) {
        const sectorData = {
            labels: [{% for sector, value in sector_distribution %}'{{ sector }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for sector, value in sector_distribution %}{{ value }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: colors.slice(0, {{ sector_distribution|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        
        new Chart(sectorCtx, {
            type: 'pie',
            data: sectorData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString('es-ES', {style: 'currency', currency: 'EUR', maximumFractionDigits: 0}) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if asset_distribution %}
    // Gr√°fico de Assets (Top 10 + Otros)
    const assetCtx = document.getElementById('assetChart');
    if (assetCtx) {
        const assetData = {
            labels: [{% for asset, value in asset_distribution %}'{{ asset }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for asset, value in asset_distribution %}{{ value }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: colors.slice(0, {{ asset_distribution|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        
        new Chart(assetCtx, {
            type: 'pie',
            data: assetData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString('es-ES', {style: 'currency', currency: 'EUR', maximumFractionDigits: 0}) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if industry_distribution %}
    // Gr√°fico de Industrias
    const industryCtx = document.getElementById('industryChart');
    if (industryCtx) {
        const industryData = {
            labels: [{% for industry, value in industry_distribution %}'{{ industry }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for industry, value in industry_distribution %}{{ value }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: colors.slice(0, {{ industry_distribution|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        
        new Chart(industryCtx, {
            type: 'pie',
            data: industryData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString('es-ES', {style: 'currency', currency: 'EUR', maximumFractionDigits: 0}) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if broker_distribution %}
    // Gr√°fico de Brokers
    const brokerCtx = document.getElementById('brokerChart');
    if (brokerCtx) {
        const brokerData = {
            labels: [{% for broker, value in broker_distribution %}'{{ broker }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for broker, value in broker_distribution %}{{ value }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: colors.slice(0, {{ broker_distribution|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        
        new Chart(brokerCtx, {
            type: 'pie',
            data: brokerData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString('es-ES', {style: 'currency', currency: 'EUR', maximumFractionDigits: 0}) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if asset_type_distribution %}
    // Gr√°fico de Tipos de Asset
    const assetTypeCtx = document.getElementById('assetTypeChart');
    if (assetTypeCtx) {
        const assetTypeData = {
            labels: [{% for asset_type, value in asset_type_distribution %}'{{ asset_type }}'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for asset_type, value in asset_type_distribution %}{{ value }}{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: colors.slice(0, {{ asset_type_distribution|length }}),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        };
        
        new Chart(assetTypeCtx, {
            type: 'pie',
            data: assetTypeData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value.toLocaleString('es-ES', {style: 'currency', currency: 'EUR', maximumFractionDigits: 0}) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if yearly_returns and yearly_returns|length > 0 %}
    // Gr√°fico de Rentabilidades A√±o a A√±o
    const yearlyReturnsCtx = document.getElementById('yearlyReturnsChart');
    if (yearlyReturnsCtx) {
        // Invertir el orden para mostrar a√±os m√°s antiguos primero (izquierda a derecha)
        const yearData = {{ yearly_returns | tojson }};
        const reversedData = [...yearData].reverse();
        
        const yearlyData = {
            labels: reversedData.map(yr => yr.year + (yr.is_ytd ? ' (YTD)' : '')),
            datasets: [{
                label: 'Rentabilidad (%)',
                data: reversedData.map(yr => yr.return_pct),
                backgroundColor: reversedData.map(yr => yr.return_pct >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                borderColor: reversedData.map(yr => yr.return_pct >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'),
                borderWidth: 2
            }]
        };
        
        new Chart(yearlyReturnsCtx, {
            type: 'bar',
            data: yearlyData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const index = context.dataIndex;
                                const absoluteGain = reversedData[index].absolute_gain;
                                return 'Rentabilidad: ' + value.toFixed(2) + '% | Ganancia: ' + 
                                       (absoluteGain >= 0 ? '+' : '') + absoluteGain.toFixed(2) + ' EUR';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if monthly_dividends and monthly_dividends|length > 0 %}
    // Gr√°fico de Dividendos Mensuales (√öltimos 12 meses)
    const monthlyDividendsCtx = document.getElementById('monthlyDividendsChart');
    if (monthlyDividendsCtx) {
        // Invertir orden para mostrar m√°s antiguo primero (izquierda a derecha)
        const monthlyData = {{ monthly_dividends | tojson }};
        const reversedData = [...monthlyData].reverse();
        
        const chartData = {
            labels: reversedData.map(d => {
                const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                return monthNames[d.month - 1] + ' ' + d.year;
            }),
            datasets: [{
                label: 'Dividendos (EUR)',
                data: reversedData.map(d => d.dividends_eur),
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2
            }]
        };
        
        new Chart(monthlyDividendsCtx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const index = context.dataIndex;
                                const count = reversedData[index].dividends_count;
                                return value.toFixed(2) + ' EUR (' + count + ' dividendo' + (count !== 1 ? 's' : '') + ')';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(0) + ' EUR';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    {% if yearly_dividends and yearly_dividends|length > 0 %}
    // Gr√°fico de Dividendos A√±o a A√±o (Desde el Inicio)
    const yearlyDividendsCtx = document.getElementById('yearlyDividendsChart');
    if (yearlyDividendsCtx) {
        // Invertir orden para mostrar m√°s antiguo primero (izquierda a derecha)
        const yearlyDivData = {{ yearly_dividends | tojson }};
        const reversedYearlyDivData = [...yearlyDivData].reverse();
        
        const yearlyDivChartData = {
            labels: reversedYearlyDivData.map(d => d.year + (d.is_ytd ? ' (YTD)' : '')),
            datasets: [{
                label: 'Dividendos (EUR)',
                data: reversedYearlyDivData.map(d => d.dividends_eur),
                backgroundColor: 'rgba(139, 92, 246, 0.7)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 2
            }]
        };
        
        new Chart(yearlyDividendsCtx, {
            type: 'bar',
            data: yearlyDivChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const index = context.dataIndex;
                                const count = reversedYearlyDivData[index].dividends_count;
                                return value.toFixed(2) + ' EUR (' + count + ' dividendo' + (count !== 1 ? 's' : '') + ')';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(0) + ' EUR';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endif %}
{% endblock %}

