{# Modal crear categorÃ­a de gasto. Usa div en lugar de form para evitar formularios anidados. #}
<div x-data="categoryModalExpense('{{ url_for('expenses.quick_create_category') }}', '{{ category_select_id }}')" x-cloak>
    <button type="button" @click="show = true; error = ''" class="ml-2 px-2 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded" title="Crear categorÃ­a">+</button>
    <div x-show="show" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4" @click.away="show=false">
            <h3 class="text-lg font-bold mb-4">Nueva categorÃ­a de gasto</h3>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                <input type="text" x-model="name" class="w-full px-3 py-2 border rounded-lg" placeholder="Ej: Suscripciones" required>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Icono</label>
                <input type="text" x-model="icon" class="w-full px-3 py-2 border rounded-lg" placeholder="ðŸ’°">
            </div>
            <div class="flex gap-2">
                <button type="button" @click="submitCategory()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Crear</button>
                <button type="button" @click="show = false" class="px-4 py-2 border rounded-lg">Cancelar</button>
            </div>
            <p x-show="error" x-text="error" class="mt-2 text-red-600 text-sm"></p>
        </div>
    </div>
</div>
<script>
document.addEventListener('alpine:init', function() {
    Alpine.data('categoryModalExpense', function(apiUrl, selectId) {
        return {
            show: false,
            name: '',
            icon: 'ðŸ’°',
            error: '',
            apiUrl: apiUrl,
            selectId: selectId,
            submitCategory: function() {
                var self = this;
                this.error = '';
                var fd = new FormData();
                var form = document.getElementById(self.selectId)?.closest('form');
fd.append('csrf_token', form?.querySelector('input[name=csrf_token]')?.value || '');
                fd.append('name', this.name);
                fd.append('icon', this.icon);
                fetch(this.apiUrl, {method: 'POST', body: fd}).then(function(r){ return r.json(); }).then(function(d) {
                    if (d.error) throw new Error(d.error);
                    var s = document.getElementById(self.selectId);
                    if (s) { var o = document.createElement('option'); o.value = d.id; o.textContent = d.label; o.selected = true; s.appendChild(o); }
                    self.show = false; self.name = ''; self.icon = 'ðŸ’°';
                }).catch(function(e) { self.error = e.message; });
            }
        };
    });
});
</script>
