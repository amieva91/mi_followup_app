{# Modal crear categorÃ­a de ingreso. Usa div en lugar de form para evitar formularios anidados. #}
<div x-data="categoryModalIncome('{{ url_for('incomes.quick_create_category') }}', '{{ category_select_id }}')" x-cloak>
    <button type="button" @click="open()" class="ml-2 px-2 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded" title="Crear categorÃ­a">+</button>
    <div x-show="show" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4" @click.away="close()">
            <h3 class="text-lg font-bold mb-4">Nueva categorÃ­a de ingreso</h3>
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                <input type="text" x-model="name" class="w-full px-3 py-2 border rounded-lg" placeholder="Ej: Freelance" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Icono</label>
                <input type="text" x-model="icon" class="w-full px-3 py-2 border rounded-lg" placeholder="ðŸ’µ">
            </div>
            <div class="flex gap-2">
                <button type="button" @click="submit()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Crear</button>
                <button type="button" @click="close()" class="px-4 py-2 border rounded-lg">Cancelar</button>
            </div>
            <p x-show="error" x-text="error" class="mt-2 text-red-600 text-sm"></p>
        </div>
    </div>
</div>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('categoryModalIncome', (apiUrl, selectId) => ({
        show: false,
        name: '',
        icon: 'ðŸ’µ',
        error: '',
        apiUrl,
        selectId,
        open() {
            this.show = true;
            this.error = '';
        },
        close() {
            this.show = false;
        },
        async submit() {
            this.error = '';
            const form = document.getElementById(this.selectId)?.closest('form');
            const formData = new FormData();
            formData.append('csrf_token', form?.querySelector('input[name="csrf_token"]')?.value || '');
            formData.append('name', this.name);
            formData.append('icon', this.icon || 'ðŸ’µ');
            try {
                const r = await fetch(this.apiUrl, { method: 'POST', body: formData });
                const data = await r.json();
                if (!r.ok) throw new Error(data.error || 'Error al crear');
                const sel = document.getElementById(this.selectId);
                if (sel) {
                    const opt = document.createElement('option');
                    opt.value = data.id;
                    opt.textContent = data.label;
                    opt.selected = true;
                    sel.appendChild(opt);
                }
                this.close();
                this.name = '';
                this.icon = 'ðŸ’µ';
            } catch (e) {
                this.error = e.message;
            }
        }
    }));
});
</script>
