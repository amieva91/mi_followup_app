{% extends "base/layout.html" %}

{% block title %}Cryptomonedas - FollowUp{% endblock %}

{% block content %}
<div class="max-w-[92%] mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">ü™ô Cryptomonedas</h1>
            <p class="text-gray-600 mt-1">Fiat, cuasi-fiat y posiciones en EUR</p>
        </div>
        <div class="flex gap-3">
            <button onclick="startPriceUpdate && startPriceUpdate()" class="btn-secondary flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Actualizar Precios
            </button>
            <a href="{{ url_for('portfolio.import_csv') }}" class="btn-secondary">üì• Importar CSV</a>
            <a href="{{ url_for('portfolio.dashboard') }}" class="btn-secondary">üìä Ver Portfolio</a>
        </div>
    </div>

    {% if metrics.posiciones %}
    <!-- M√©tricas principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Capital invertido -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-500">
            <div class="text-sm text-gray-600 mb-1">üí∞ Capital invertido</div>
            <div class="text-2xl font-bold text-indigo-600">{{ metrics.capital_invertido|decimal_eu(2) }} EUR</div>
        </div>

        <!-- Cuasi-fiat -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-amber-500">
            <div class="text-sm text-gray-600 mb-1">ü™ô Cuasi-fiat (stablecoins)</div>
            <div class="text-2xl font-bold text-amber-600">{{ metrics.cuasi_fiat|decimal_eu(2) }} EUR</div>
        </div>

        <!-- Valor total -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
            <div class="text-sm text-gray-600 mb-1">üìà Valor actual</div>
            <div class="text-2xl font-bold text-blue-600">{{ metrics.valor_total|decimal_eu(2) }} EUR</div>
        </div>

        <!-- P&L Total -->
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 {% if metrics.pl_total >= 0 %}border-green-500{% else %}border-red-500{% endif %}">
            <div class="text-sm text-gray-600 mb-1">üìä P&L Total</div>
            <div class="text-2xl font-bold {% if metrics.pl_total >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if metrics.pl_total >= 0 %}+{% endif %}{{ metrics.pl_total|decimal_eu(2) }} EUR
            </div>
            <div class="text-sm {% if metrics.pl_pct_total >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {% if metrics.pl_pct_total >= 0 %}+{% endif %}{{ metrics.pl_pct_total|decimal_eu(2) }}%
            </div>
        </div>
    </div>

    <!-- Fiat total + Rewards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="text-sm text-gray-600 mb-1">üíµ Fiat total (capital + cuasi-fiat)</div>
            <div class="text-xl font-bold text-gray-900">{{ metrics.fiat_total|decimal_eu(2) }} EUR</div>
            <p class="text-xs text-gray-500 mt-1">Desglose: capital {{ metrics.capital_invertido|decimal_eu(2) }} + cuasi-fiat {{ metrics.cuasi_fiat|decimal_eu(2) }}</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="text-sm text-gray-600 mb-1">üéÅ Rewards (valor estimado)</div>
            <div class="text-xl font-bold text-purple-600">{{ metrics.rewards_total|decimal_eu(2) }} EUR</div>
            <p class="text-xs text-gray-500 mt-1">Staking rewards valorados al precio actual</p>
        </div>
    </div>

    <!-- Tabla de posiciones -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b">
            <h2 class="text-lg font-semibold text-gray-800">Posiciones</h2>
            <p class="text-sm text-gray-500">Activos crypto con coste, valor y P&L</p>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activo</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Precio medio</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Precio</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Coste</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Valor</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">P&L</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Rewards</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for p in metrics.posiciones %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-900">{{ p.symbol }}</span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm text-gray-700">{{ p.quantity|decimal_eu(4) }}</td>
                    <td class="px-6 py-4 text-right text-sm text-gray-700">{{ (p.average_buy_price or (p.cost / p.quantity if p.quantity else 0))|decimal_eu(5) if (p.average_buy_price or p.quantity) else '‚Äî' }}</td>
                    <td class="px-6 py-4 text-right text-sm text-gray-700">{{ p.price|decimal_eu(4) if p.price else '‚Äî' }}</td>
                    <td class="px-6 py-4 text-right text-sm text-gray-700">{{ p.cost|decimal_eu(2) }} ‚Ç¨</td>
                    <td class="px-6 py-4 text-right text-sm text-gray-700">{{ p.value|decimal_eu(2) }} ‚Ç¨</td>
                    <td class="px-6 py-4 text-right text-sm {% if p.pl >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {% if p.pl >= 0 %}+{% endif %}{{ p.pl|decimal_eu(2) }} ‚Ç¨
                        <span class="text-xs">({% if p.pl_pct >= 0 %}+{% endif %}{{ p.pl_pct|decimal_eu(1) }}%)</span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm text-purple-600">
                        {% if p.reward_quantity > 0 %}{{ p.reward_value|decimal_eu(2) }} ‚Ç¨{% else %}‚Äî{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <!-- Estado vac√≠o -->
    <div class="bg-white rounded-xl shadow-sm p-12 text-center">
        <div class="text-6xl mb-4">ü™ô</div>
        <h2 class="text-xl font-semibold text-gray-800 mb-2">Sin posiciones en cryptomonedas</h2>
        <p class="text-gray-600 mb-6">Sube tu extracto Revolut X para importar tus posiciones</p>
        <a href="{{ url_for('portfolio.import_csv') }}" class="btn-primary inline-flex items-center gap-2">
            üì• Importar CSV Revolut X
        </a>
    </div>
    {% endif %}
</div>

<!-- Modal de actualizaci√≥n de precios (compartido con Portfolio) -->
<div id="priceUpdateModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modalTitle" class="text-lg font-medium text-gray-900">üîÑ Actualizando precios...</h3>
                <div id="spinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span id="progressText">0 / 0</span>
                    <span id="estimatedTime"></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div id="results" class="hidden mb-4">
                <div class="text-sm text-gray-600 space-y-1">
                    <div class="flex justify-between"><span>‚úÖ Actualizados:</span><span id="successCount" class="font-medium text-green-600">0</span></div>
                    <div class="flex justify-between"><span>‚ùå Fallidos:</span><span id="failedCount" class="font-medium text-red-600">0</span></div>
                    <div class="flex justify-between"><span>‚ö†Ô∏è Omitidos:</span><span id="skippedCount" class="font-medium text-orange-600">0</span></div>
                </div>
            </div>
            <div id="errorMessage" class="hidden text-sm text-red-600 mb-4"></div>
            <div class="flex justify-end">
                <button onclick="closePriceModal()" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Actualizar precios: mismo flujo que Portfolio, al terminar recarga /crypto/
function startPriceUpdate() {
    const modal = document.getElementById('priceUpdateModal');
    const modalTitle = document.getElementById('modalTitle');
    const spinner = document.getElementById('spinner');
    const results = document.getElementById('results');
    const errorMessage = document.getElementById('errorMessage');
    modal.classList.remove('hidden');
    modalTitle.textContent = 'üîÑ Actualizando precios...';
    spinner.classList.remove('hidden');
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0 / 0';
    results.classList.add('hidden');
    errorMessage.classList.add('hidden');

    const formData = new FormData();
    formData.append('csrf_token', document.querySelector('meta[name="csrf-token"]')?.content || document.querySelector('input[name="csrf_token"]')?.value || '');

    fetch('{{ url_for("portfolio.update_prices") }}', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'started') pollPriceProgress();
            else errorMessage.textContent = 'Error al iniciar actualizaci√≥n';
        })
        .catch(err => { errorMessage.textContent = 'Error de red: ' + err.message; errorMessage.classList.remove('hidden'); });

    function pollPriceProgress() {
        fetch('{{ url_for("portfolio.price_update_progress") }}')
            .then(r => r.json())
            .then(data => {
                if (data.total > 0) {
                    document.getElementById('progressBar').style.width = (data.current / data.total * 100) + '%';
                    document.getElementById('progressText').textContent = data.current + ' / ' + data.total;
                }
                if (data.status === 'completed' || data.status === 'failed') {
                    spinner.classList.add('hidden');
                    if (data.status === 'completed') {
                        modalTitle.textContent = '‚úÖ Actualizaci√≥n completada';
                        results.classList.remove('hidden');
                        const r = data.result || {};
                        document.getElementById('successCount').textContent = data.success ?? r.success ?? 0;
                        document.getElementById('failedCount').textContent = data.failed ?? r.failed ?? 0;
                        document.getElementById('skippedCount').textContent = data.skipped ?? r.skipped ?? 0;
                    } else {
                        modalTitle.textContent = '‚ùå Error';
                        errorMessage.textContent = data.message || 'Error desconocido';
                        errorMessage.classList.remove('hidden');
                    }
                } else {
                    setTimeout(pollPriceProgress, 500);
                }
            })
            .catch(() => setTimeout(pollPriceProgress, 1000));
    }
}
function closePriceModal() {
    document.getElementById('priceUpdateModal').classList.add('hidden');
    window.location.reload();  // Recarga /crypto/ para mostrar precios actualizados
}
</script>
{% endblock %}
