{% extends 'base/layout.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-[92%] mx-auto px-4 py-8">
    <!-- Header -->
    <h1 class="text-3xl font-bold text-gray-800 mb-6">{{ title }}</h1>

    <!-- Advertencia para series -->
    {% if is_part_of_series %}
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">Est√°s editando una serie recurrente</h3>
                    <p class="text-sm text-yellow-700 mt-1">
                        Los cambios que realices se aplicar√°n a <strong>TODAS las entradas de esta serie</strong>.
                        Las fechas individuales se mantendr√°n, pero el resto de campos (monto, descripci√≥n, etc.) se actualizar√°n en todas las entradas.
                    </p>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Formulario -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="POST" action="" id="income-form" novalidate>
            {{ form.hidden_tag() }}

            <!-- Categor√≠a -->
            <div class="mb-4">
                {{ form.category_id.label(class="block text-gray-700 font-semibold mb-2") }}
                <div class="flex items-center gap-2">
                    {{ form.category_id(id='category_id', class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500") }}
                    {% set category_select_id = 'category_id' %}
                    {% include 'components/category_modal_income.html' %}
                </div>
                {% if form.category_id.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {% for error in form.category_id.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- Monto y Fecha en Grid -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- Monto -->
                <div>
                    {{ form.amount.label(class="block text-gray-700 font-semibold mb-2") }}
                    {{ form.amount(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500") }}
                    {% if form.amount.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {% for error in form.amount.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Fecha -->
                <div>
                    {{ form.date.label(class="block text-gray-700 font-semibold mb-2") }}
                    {{ form.date(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500") }}
                    {% if form.date.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {% for error in form.date.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Descripci√≥n -->
            <div class="mb-4">
                {{ form.description.label(class="block text-gray-700 font-semibold mb-2") }}
                {{ form.description(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500") }}
                {% if form.description.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {% for error in form.description.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- Notas -->
            <div class="mb-6">
                {{ form.notes.label(class="block text-gray-700 font-semibold mb-2") }}
                {{ form.notes(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500") }}
            </div>

            <!-- Checkbox Recurrente -->
            <div class="mb-4 bg-green-50 p-4 rounded-lg">
                <label class="flex items-center space-x-3 cursor-pointer">
                    {{ form.is_recurring(class="w-5 h-5", id="is_recurring") }}
                    <span class="text-gray-700 font-semibold">Este ingreso es recurrente (se repite peri√≥dicamente)</span>
                </label>
            </div>

            <!-- Campos de Recurrencia (se muestran solo si is_recurring est√° marcado) -->
            <div id="recurrence-fields" class="mb-6 border-l-4 border-green-500 pl-4" style="display: {{ 'block' if form.is_recurring.data else 'none' }};">
                <h3 class="font-bold text-gray-700 mb-3">‚öôÔ∏è Configuraci√≥n de Recurrencia</h3>
                
                <!-- Frecuencia y Fecha Fin -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        {{ form.recurrence_frequency.label(class="block text-gray-700 font-semibold mb-2") }}
                        {{ form.recurrence_frequency(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500") }}
                        {% if form.recurrence_frequency.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.recurrence_frequency.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div>
                        {{ form.recurrence_end_date.label(class="block text-gray-700 font-semibold mb-2") }}
                        {{ form.recurrence_end_date(class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500") }}
                        {% if form.recurrence_end_date.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.recurrence_end_date.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">
                            Dejar vac√≠o para sin fecha de fin
                        </p>
                    </div>
                </div>
            </div>

            <div class="flex space-x-3 mt-4">
                <button type="button" onclick="var f=document.getElementById('income-form');f.requestSubmit?f.requestSubmit():f.submit()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition font-semibold">
                    Guardar Ingreso
                </button>
                <a href="{{ url_for('incomes.list') }}" 
                   class="flex-1 text-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg transition font-semibold">
                    Cancelar
                </a>
            </div>
        </form>
    </div>

    <!-- Ayuda -->
    <div class="mt-6 bg-yellow-50 rounded-lg p-4">
        <p class="font-semibold text-gray-700 mb-2">üí° Sobre ingresos recurrentes:</p>
        <ul class="text-sm text-gray-600 space-y-1">
            <li>‚Ä¢ <strong>Semanal:</strong> Cada semana (ej: propinas semanales)</li>
            <li>‚Ä¢ <strong>Mensual:</strong> Cada mes (ej: salario, alquiler de propiedad)</li>
            <li>‚Ä¢ <strong>Anual:</strong> Cada a√±o (ej: bonus anual, dividendos)</li>
        </ul>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var cb = document.getElementById('is_recurring');
    var div = document.getElementById('recurrence-fields');
    if (!cb || !div) return;
    var freqSelect = div.querySelector('select[name="recurrence_frequency"]');
    cb.addEventListener('change', function() {
        div.style.display = this.checked ? 'block' : 'none';
        if (freqSelect && !this.checked) freqSelect.value = '';
    });
});
</script>
{% endblock %}

