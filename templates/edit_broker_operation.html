{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1 class="mt-4">Editar Operación de Broker</h1>
    <p>Modifica los detalles de la operación seleccionada.</p>
    
    <div class="row">
        <div class="col-md-6 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5>Editar Operación</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('edit_broker_operation', operation_id=operation.id) }}" id="edit-broker-form">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ form.date.label(class="form-label") }}
                            {{ form.date(class="form-control") }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.operation_type.label(class="form-label") }}
                            {{ form.operation_type(class="form-select") }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.concept.label(class="form-label") }}
                            {{ form.concept(class="form-select") }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.amount.label(class="form-label") }}
                            {{ form.amount(class="form-control") }}
                            <div class="form-text">Introduce la cantidad en positivo. El sistema aplicará automáticamente el signo según el tipo de operación.</div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control") }}
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            {{ form.submit(class="btn btn-primary", value="Guardar Cambios") }}
                            <a href="{{ url_for('broker_operations') }}" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para actualizar las opciones del campo 'concept' basado en el tipo de operación
    function updateConceptOptions() {
        const operationType = document.getElementById('operation_type');
        const conceptSelect = document.getElementById('concept');
        
        if (!operationType || !conceptSelect) {
            console.error("No se encontraron los elementos necesarios");
            return;
        }
        
        const selectedType = operationType.value;
        console.log("Tipo de operación seleccionado:", selectedType);
        
        // Guardar selección actual si existe
        const currentSelection = conceptSelect.value;
        
        // Limpiar opciones actuales
        conceptSelect.innerHTML = '';
        
        // Opciones por defecto según tipo de operación
        let options = [];
        
        if (selectedType === 'Ingreso') {
            options = [['Inversión', 'Inversión']];
        } else if (selectedType === 'Retirada') {
            options = [
                ['Dividendos', 'Dividendos (OBSOLETO - Usar Reinversión)'],
                ['Desinversión', 'Desinversión']
            ];
        } else if (selectedType === 'Comisión') {
            options = [
                ['Compra/Venta', 'Comisión de Compra/Venta'],
                ['Apalancamiento', 'Comisión de Apalancamiento'],
                ['Otras', 'Otras Comisiones']
            ];
        } else if (selectedType === 'Reinversión') {
            options = [['Dividendo', 'Dividendo']];
        }
        
        // Añadir nuevas opciones
        options.forEach(function(option) {
            const optElement = document.createElement('option');
            optElement.value = option[0];
            optElement.textContent = option[1];
            conceptSelect.appendChild(optElement);
        });
        
        // Intentar restaurar selección previa si aún está disponible
        if (currentSelection) {
            const optionExists = Array.from(conceptSelect.options).some(option => option.value === currentSelection);
            if (optionExists) {
                conceptSelect.value = currentSelection;
            }
        }
    }
    
    // Actualizar al cambiar el tipo de operación
    const operationTypeSelect = document.getElementById('operation_type');
    if (operationTypeSelect) {
        operationTypeSelect.addEventListener('change', updateConceptOptions);
    }
    
    // Validación de formato de cantidades
    const editBrokerForm = document.getElementById('edit-broker-form');
    if (editBrokerForm) {
        editBrokerForm.addEventListener('submit', function(event) {
            const amountField = document.getElementById('amount');
            if (!amountField) {
                console.error("No se encontró el campo #amount");
                return;
            }
            
            const amountValue = amountField.value.replace(',', '.');
            const amount = parseFloat(amountValue);
            
            if (isNaN(amount) || amount <= 0) {
                event.preventDefault();
                alert('Por favor, introduce una cantidad positiva válida.');
                amountField.focus();
            } else {
                amountField.value = amountValue;
            }
        });
    }
});
</script>
{% endblock scripts %}
